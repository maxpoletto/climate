<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
    <title>Swiss Energy Explorer</title>
    <script src="https://unpkg.com/deck.gl@latest/dist.min.js"></script>
    <link href="https://unpkg.com/deck.gl@latest/dist/stylesheet.css" rel='stylesheet' />
    <script src="https://cdn.maptiler.com/maptiler-sdk-js/v3.0.1/maptiler-sdk.umd.min.js"></script>
    <link href="https://cdn.maptiler.com/maptiler-sdk-js/v3.0.1/maptiler-sdk.css" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.1/nouislider.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.1/nouislider.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/hammerjs@2.0.8"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
    <script>
        // Register zoom plugin once all scripts are loaded
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof Chart !== 'undefined') {
                if (Chart.Zoom) {
                    Chart.register(Chart.Zoom);
                    console.log('Registered zoom plugin from Chart.Zoom');
                } else if (window.ChartZoom) {
                    Chart.register(window.ChartZoom);
                    console.log('Registered zoom plugin from window.ChartZoom');
                } else {
                    console.log('Checking window object for zoom plugin...');
                    console.log('Available window properties:', Object.keys(window).filter(k => k.toLowerCase().includes('zoom')));
                }
            }
            initialize();
        });
    </script>
    <script src="app.js"></script>
    <link href="style.css" rel="stylesheet">
</head>
<body>
    <div id="loadingOverlay">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <h3>Loading Swiss energy data</h3>
            <p>Fetching data for 300,000+ facilities and 4,000+ production days...</p>
        </div>
    </div>

    <div id="tabNavigation" class="tab-navigation">
        <button id="facilitiesTab" class="tab-button active">‚öôÔ∏è Facilities</button>
        <button id="productionTab" class="tab-button">‚ö° Production</button>
        <button id="tradeTab" class="tab-button">üîÑ Import/Export</button>
        <button id="aboutTab" class="tab-button">‚ÑπÔ∏è About</button>
    </div>

    <div class="mode" id="facilitiesMode">
        <div id="map"></div>
        <div id="tableView"">
            <div id="tableContainer">
                <div id="tableHeader">
                    <div id="tableControls">
                        <div id="paginationControls">
                            <button id="firstPage" disabled>&lt;&lt;</button>
                            <button id="prevPage" disabled>&lt;</button>
                            <span id="pageInfo">Page <span id="currentPageNumber" style="cursor: pointer; text-decoration: underline; color: #2196F3;">1</span> of <span id="totalPages">1</span></span>
                            <button id="nextPage" disabled>&gt;</button>
                            <button id="lastPage" disabled>&gt;&gt;</button>
                        </div>
                    </div>
                </div>
                <div id="tableWrapper">
                    <table id="facilitiesTable">
                        <thead id="facilitiesTableHead">
                            <tr>
                                <th data-sort="type" class="sortable">
                                    Energy Source <span class="sort-indicator">‚Üï</span>
                                </th>
                                <th data-sort="power" class="sortable numeric">
                                    Power (kW) <span class="sort-indicator">‚Üï</span>
                                </th>
                                <th data-sort="town" class="sortable">
                                    Municipality <span class="sort-indicator">‚Üï</span>
                                </th>
                                <th data-sort="canton" class="sortable">
                                    Canton <span class="sort-indicator">‚Üï</span>
                                </th>
                                <th data-sort="date" class="sortable date">
                                    Started <span class="sort-indicator">‚Üï</span>
                                </th>
                                <th data-sort="gps" class="sortable">
                                    GPS <span class="sort-indicator">‚Üï</span>
                                </th>
                            </tr>
                        </thead>
                        <tbody id="facilitiesTableBody">
                            <!-- Table rows will be populated dynamically -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <div class="mode" id="productionMode">
        <div class="chart-controls">
            <span class="chart-help">
                Zoom: mouse wheel or pinch or -/_/+/= keys ‚Ä¢ Pan: tap/click + drag or arrow keys.<br/>
                Bars adapt: daily‚Üíweekly‚Üímonthly‚Üíquarterly
            </span>
            <button id="resetProductionZoom" class="reset-zoom-btn">Reset Zoom</button>
        </div>
        <div id="productionContainer" class="time-series">
            <div id="productionChartContainer">
                <canvas id="productionChart" class="chart-canvas"></canvas>
            </div>
        </div>
    </div>
    <div class="mode" id="tradeMode">
        <div class="chart-controls">
            <span class="chart-help">
                Zoom: mouse wheel or pinch or -/_/+/= keys ‚Ä¢ Pan: tap/click + drag or arrow keys.<br/>
                Bars adapt: daily‚Üíweekly‚Üímonthly‚Üíquarterly
            </span>
            <button id="resetTradeZoom" class="reset-zoom-btn">Reset Zoom</button>
        </div>
        <div id="tradeContainer">
            <div id="tradeChartContainer">
                <canvas id="tradeChart" class="chart-canvas"></canvas>
            </div>
        </div>
    </div>
    <div class="mode" id="aboutMode">
        <div class="about-content">
            <h3>Swiss Energy Explorer</h3>

            <p>This tool displays electricity generation facilities in Switzerland and daily Swiss electricity production since 2015.</p>

            <h4>Instructions</h4>
            <ul>
                <li><strong>Mode tabs</strong>
                    <p>Click the <strong>Facilities</strong>, <strong>Production</strong>, or <strong>Import/Export</strong> tab at the top to switch between different views of Switzerland's energy data.</p>
                </li>
                <li><strong>Table / Map view toggle</strong>
                    <p>Within the facilities tab, click <strong>Table View</strong> to switch from map to table, or <strong>Map View</strong> to switch from table to map.</p>
                </li>
                <li><strong>Energy sources panel</strong>
                    <p>Controls what facilities are displayed and counted.</p>
                    <ul>
                        <li>Check/uncheck energy source types (biomass, hydro, etc.).</li>
                        <li>Use the power slider to filter by facility capacity.</li>
                        <li>Use the search box to find facilities by name, municipality, canton, or start year.</li>
                    </ul>
                </li>
                <li><strong>Map view</strong>
                    <p>Facilities are shown as colored circles. Circle size represents power capacity. Circle color represents energy source type.</p>
                    <p>Hover over any circle to see details.</p>
                </li>
                <li><strong>Table view</strong>
                    <p>Shows filtered facilities in a sortable, paginated table.</p>
                    <p>Click any column header to sort by that column.</p>
                </li>
                <li><strong>Production mode</strong>
                    <p>Shows historical electricity production data by energy source. Use the checkboxes to select which energy sources to display. The chart automatically adjusts time granularity based on zoom level (daily ‚Üí weekly ‚Üí monthly ‚Üí quarterly).</p>
                    <p>Hover over any bar to see details for the corresponding time period.</p>
                </li>
                <li><strong>Import/Export mode</strong>
                    <p>Shows Switzerland's electricity trade with neighboring countries (Austria, Germany, France, Italy). Positive values represent net imports, negative values represent net exports. The behavior of the control panel and zooming and panning controls are the same as in production mode.</p>
                </li>
            </ul>

            <h4>About the data</h4>
            <p>The facilities dataset contains all operational electricity production facilities registered in the Swiss Certificate of Origin system, including:</p>
            <ul>
                <li>All facilities with capacity greater than 30 kVA.</li>
                <li>Smaller facilities (>2 kW) voluntarily registered for certificates.</li>
                <li>Facilities subsidized via feed-in tariffs, one-time payments, or investment contributions pursuant to the 2021 Swiss Energy Act.</li>
            </ul>

            <p>The production data contains aggregate energy production broken down by day and energy source, starting on 2015-01-01.</p>
            <p>The trade data contains aggregate energy trade with neighboring countries (Austria, Germany, France, Italy) broken down by day and country, starting on 2017-01-01.</p>
            <p><strong>Unfortunately, the production source types are not exactly the same as those in the facilities dataset, and there are no public per-facility production records.</strong></p>

            <p>The Swiss Federal Office of Energy updates the data regularly. This app polls the data daily.</p>

            <h4>Data sources</h4>
            <p><strong>Swiss Federal Office of Energy (BFE):</strong>
            <a href="https://www.bfe.admin.ch/bfe/de/home/versorgung/digitalisierung-und-geoinformation/geoinformation/geodaten/produktionsanlagen/elektrizitaetsproduktionsanlagen.html" target="_blank">Electricity Production Facilities Documentation</a></p>

            <p><strong>BFE facilities data (Open Government Data Portal):</strong>
            <a href="https://opendata.swiss/de/dataset/elektrizitatsproduktionsanlagen/resource/3a10b118-2382-4fc1-9571-e61d0294778e" target="_blank">CSV</a></p>

            <p><strong>Swissgrid production data (Open Government Data Portal):</strong>
            <a href="https://www.uvek-gis.admin.ch/BFE/ogd/104/ogd104_stromproduktion_swissgrid.csv" target="_blank">CSV</a></p>

            <p><strong>Import/export data (OGDP / ENTSO-E):</strong>
            <a href="https://www.uvek-gis.admin.ch/BFE/ogd/107/ogd107_strom_import_export.csv" target="_blank">CSV</a></p>
        </div>
    </div>
    <div id="controls">
        <div class="control-section facilities-controls">
            <button id="viewToggle">üìä Table View</button>
        </div>
        <div class="control-section facilities-controls">
            <h3>Energy Sources</h3>
            <table id="categoryTable" class="category-table">
                <thead>
                    <tr>
                        <th>Source</th>
                        <th>Count</th>
                        <th>MW</th>
                    </tr>
                </thead>
                <tbody id="facilitiesCategoryTableBody">
                    <!-- Table rows will be populated dynamically -->
                </tbody>
                <tfoot>
                    <tr class="totals-row">
                        <td>Selected Totals</td>
                        <td id="totalCount" class="count-cell">-</td>
                        <td id="totalCapacity" class="capacity-cell">-</td>
                    </tr>
                </tfoot>
            </table>
        </div>
        <div class="control-section facilities-controls">
            <h3>Power Range: <span id="currentPowerRange">0.1 kW - 2 GW</span></h3>
            <div class="power-control">
                <div id="powerRangeSlider"></div>
                <div class="power-values">
                    <span>0.1 kW</span>
                    <span>2 GW</span>
                </div>
            </div>
        </div>
        <div class="control-section facilities-controls">
            <h3>Search</h3>
            <input type="text" id="searchInput" placeholder="(e.g., 'canton:vs', 'year:2021', 'z√ºrich', ...)" />
        </div>
        <div class="control-section production-controls">
            <h3>Energy Sources</h3>
            <table id="productionCategoryTable" class="category-table">
                <thead>
                    <tr>
                        <th>Source</th>
                        <th>Mean<br/>GWh/day</th>
                    </tr>
                </thead>
                <tbody id="productionCategoryTableBody">
                    <!-- Table rows will be populated dynamically -->
                </tbody>
                <tfoot>
                    <tr class="totals-row">
                        <td>Selected Totals</td>
                        <td id="totalProduction" class="capacity-cell">-</td>
                    </tr>
                </tfoot>
            </table>
        </div>
        <div class="control-section trade-controls">
            <h3>Countries</h3>
            <table id="tradeCategoryTable" class="category-table">
                <thead>
                    <tr>
                        <th>Country</th>
                        <th>Mean Net Import<br/>GWh/day</th>
                    </tr>
                </thead>
                <tbody id="tradeCategoryTableBody">
                    <!-- Table rows will be populated dynamically -->
                </tbody>
                <tfoot>
                    <tr class="totals-row">
                        <td>Selected Totals</td>
                        <td id="totalTrade" class="capacity-cell">-</td>
                    </tr>
                </tfoot>
            </table>
        </div>
        <div class="annotations" id="annotations"></div>
    </div>
</body>
</html>
