<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
    <title>Swiss Energy Explorer</title>
    <script src="https://unpkg.com/deck.gl@latest/dist.min.js"></script>
    <link href="https://unpkg.com/deck.gl@latest/dist/stylesheet.css" rel='stylesheet' />
    <script src="https://cdn.maptiler.com/maptiler-sdk-js/v3.0.1/maptiler-sdk.umd.min.js"></script>
    <link href="https://cdn.maptiler.com/maptiler-sdk-js/v3.0.1/maptiler-sdk.css" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.1/nouislider.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.1/nouislider.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/hammerjs@2.0.8"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
    <script>
        // Register zoom plugin once all scripts are loaded
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof Chart !== 'undefined') {
                if (Chart.Zoom) {
                    Chart.register(Chart.Zoom);
                    console.log('Registered zoom plugin from Chart.Zoom');
                } else if (window.ChartZoom) {
                    Chart.register(window.ChartZoom);
                    console.log('Registered zoom plugin from window.ChartZoom');
                } else {
                    console.log('Checking window object for zoom plugin...');
                    console.log('Available window properties:', Object.keys(window).filter(k => k.toLowerCase().includes('zoom')));
                }
            }
            initialize();
        });
    </script>
    <script src="app.js"></script>
    <link href="style.css" rel="stylesheet">
</head>
<body>
    <div id="loadingOverlay">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <h3>Loading Swiss energy data</h3>
            <p>Fetching data for 290,000+ facilities and 4,000+ production days...</p>
        </div>
    </div>

    <button class="info-button" id="infoButton">?</button>
    <div id="map"></div>
    <div id="tableView" style="display: none;">
        <div id="tableContainer">
            <div id="tableHeader">
                <div id="tableControls">
                    <div id="paginationControls">
                        <button id="firstPage" disabled>&lt;&lt;</button>
                        <button id="prevPage" disabled>&lt;</button>
                        <span id="pageInfo">Page <span id="currentPageNumber" style="cursor: pointer; text-decoration: underline; color: #2196F3;">1</span> of <span id="totalPages">1</span></span>
                        <button id="nextPage" disabled>&gt;</button>
                        <button id="lastPage" disabled>&gt;&gt;</button>
                    </div>
                </div>
            </div>
            <div id="tableWrapper">
                <table id="facilitiesTable">
                    <thead id="facilitiesTableHead">
                        <tr>
                            <th data-sort="SubCategory" class="sortable">
                                Energy Source <span class="sort-indicator">‚Üï</span>
                            </th>
                            <th data-sort="TotalPower" class="sortable numeric">
                                Power (kW) <span class="sort-indicator">‚Üï</span>
                            </th>
                            <th data-sort="Municipality" class="sortable">
                                Municipality <span class="sort-indicator">‚Üï</span>
                            </th>
                            <th data-sort="Canton" class="sortable">
                                Canton <span class="sort-indicator">‚Üï</span>
                            </th>
                            <th data-sort="BeginningOfOperation" class="sortable date">
                                Started <span class="sort-indicator">‚Üï</span>
                            </th>
                            <th data-sort="gps" class="sortable">
                                GPS <span class="sort-indicator">‚Üï</span>
                            </th>
                        </tr>
                    </thead>
                    <tbody id="facilitiesTableBody">
                        <!-- Table rows will be populated dynamically -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    <div id="productionView">
        <div class="chart-controls">
            <span class="chart-help">
                Zoom: mouse wheel or pinch or -/_/+/= keys ‚Ä¢ Pan: tap/click + drag or arrow keys.<br/>
                Bars adapt: daily‚Üíweekly‚Üímonthly‚Üíquarterly
            </span>
            <button id="resetZoom" class="reset-zoom-btn">Reset Zoom</button>
        </div>
        <div id="productionContainer">
            <div id="productionChartContainer">
                <canvas id="productionChart"></canvas>
            </div>
        </div>
    </div>
    <div id="controls">
        <div class="control-section">
            <div class="mode-toggle-group">
                <button id="facilitiesMode" class="mode-toggle-btn active">‚öôÔ∏è Facilities</button>
                <button id="productionMode" class="mode-toggle-btn">‚ö° Production</button>
            </div>
        </div>
        <div class="control-section facilities-controls">
            <button id="viewToggle" class="view-toggle-btn">üìä Table View</button>
        </div>
        <div class="control-section facilities-controls">
            <h3>Energy Sources</h3>
            <table id="categoryTable" class="category-table">
                <thead>
                    <tr>
                        <th>Source</th>
                        <th>Count</th>
                        <th>MW</th>
                    </tr>
                </thead>
                <tbody id="categoryTableBody">
                    <!-- Table rows will be populated dynamically -->
                </tbody>
                <tfoot>
                    <tr class="totals-row">
                        <td>Selected Totals</td>
                        <td id="totalCount" class="count-cell">-</td>
                        <td id="totalCapacity" class="capacity-cell">-</td>
                    </tr>
                </tfoot>
            </table>
        </div>
        <div class="control-section facilities-controls">
            <h3>Power Range: <span id="currentPowerRange">0.1 kW - 2 GW</span></h3>
            <div class="power-control">
                <div id="powerRangeSlider"></div>
                <div class="power-values">
                    <span>0.1 kW</span>
                    <span>2 GW</span>
                </div>
            </div>
        </div>
        <div class="control-section facilities-controls">
            <h3>Search</h3>
            <input type="text" id="searchInput" placeholder="(e.g., 'canton:vs', 'year:2021', 'z√ºrich', ...)" />
        </div>
        <div class="control-section production-controls">
            <h3>Energy Sources</h3>
            <table id="productionCategoryTable" class="category-table">
                <thead>
                    <tr>
                        <th>Source</th>
                        <th>Mean<br/>GWh/day</th>
                    </tr>
                </thead>
                <tbody id="productionCategoryTableBody">
                    <!-- Table rows will be populated dynamically -->
                </tbody>
            </table>
        </div>
        <div class="annotations" id="annotations"></div>
    </div>

    <div class="info-modal" id="infoModal">
        <div class="info-modal-content">
            <button class="close-modal" id="closeModal">&times;</button>
            <h3>Swiss Energy Explorer</h3>

            <p>This tool displays electricity generation facilities in Switzerland and daily Swiss electricity production since 2015.</p>

            <h4>Instructions</h4>
            <ul>
                <li><strong>Facilities / Production mode toggle</strong>
                    <p>Click the <strong>Facilities</strong> or <strong>Production</strong> button to switch between facilities and production mode.</p>
                </li>
                <li><strong>Table / Map view toggle</strong>
                    <p>Within facilities mode, click <strong>Table View</strong> to switch from map to table, or <strong>Map View</strong> to switch from table to map.</p>
                </li>
                <li><strong>Energy sources panel</strong>
                    <p>Controls what facilities are displayed and counted.</p>
                    <ul>
                        <li>Check/uncheck energy source types (biomass, hydro, etc.).</li>
                        <li>In facilities mode, drag the handles of the power range slider to filter facilities by their power output.</li>
                        <li>In facilities mode, use the search input to filter facilities by name, municipality, canton, or energy source. Supports case-insensitive free-form substring match, e.g., 'vs hydro 2021',
                            and also the keywords 'canton' (e.g., 'canton:be'),'city' (e.g., 'city:z√ºrich'), and 'year' (tip: e.g., 'year:202' matches any facility started in the 2020s).
                        </li>
                    </ul>
                    <p>Counters update in real time as you change the filters.</p>
                </li>
                <li><strong>Facilities map view</strong>
                    <p>Zoom: mouse wheel or pinch or -/_/+/= keys. Pan: tap/click + drag. Rotate/tilt: Shift+drag. Hover over any facility for details.</p>
                    <p>The dataset does not contain GPS coordinates for all facilities, so not all facilities are displayed on the map.</p>
                </li>
                <li><strong>Facilities table view</strong>
                    <p>View all facilities, including ones without GPS coordinates.</p>
                    <p>Use the pagination controls to navigate (click on the page number to jump to a specific page).</p>
                    <p>Use the column headers to sort.</p>
                </li>
                <li><strong>Production mode</strong>
                    <p>The chart by default shows the entire time range (2015 to present) broken down by quarters.</p>
                    <p>Zoom: mouse wheel or pinch or -/_/+/= keys. Pan: tap/click + drag or arrow keys. Summary statistics in the sources panel update as you move around.
                        Bars rescale (quarters ‚Üí months ‚Üí weeks ‚Üí days) as you zoom in.</p>
                    <p>Hover over any bar to see details for the corresponding time period.</p>
                </li>
            </ul>

            <h4>About the data</h4>
            <p>The facilities dataset contains all operational electricity production facilities registered in the Swiss Certificate of Origin system, including:</p>
            <ul>
                <li>All facilities with capacity greater than 30 kVA.</li>
                <li>Smaller facilities (>2 kW) voluntarily registered for certificates.</li>
                <li>Facilities subsidized via feed-in tariffs, one-time payments, or investment contributions pursuant to the 2021 Swiss Energy Act.</li>
            </ul>

            <p>The production data contains aggregate energy production broken down by day and energy source, starting on 2015-01-01.</p>
            <p><strong>Unfortunately, the production source types are not exactly the same as those in the facilities dataset, and there are no public per-facility production records.</strong></p>

            <p>Facilities data is updated quarterly. Production data is updated weekly (with 1-day granularity).</p>

            <h4>Data sources</h4>
            <p><strong>Swiss Federal Office of Energy (BFE):</strong>
            <a href="https://www.bfe.admin.ch/bfe/de/home/versorgung/digitalisierung-und-geoinformation/geoinformation/geodaten/produktionsanlagen/elektrizitaetsproduktionsanlagen.html" target="_blank">Electricity Production Facilities Documentation</a></p>

            <p><strong>BFE facilities data (Open Government Data Portal):</strong>
            <a href="https://opendata.swiss/de/dataset/elektrizitatsproduktionsanlagen/resource/3a10b118-2382-4fc1-9571-e61d0294778e" target="_blank">CSV</a></p>

            <p><strong>Swissgrid production data (Open Government Data Portal):</strong>
            <a href="https://www.uvek-gis.admin.ch/BFE/ogd/104/ogd104_stromproduktion_swissgrid.csv" target="_blank">CSV</a></p>
        </div>
    </div>
</body>
</html>
