<!DOCTYPE html>
<html>
<head>
    <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
    <title>Swiss Energy Facilities Map</title>
    <script src="https://unpkg.com/deck.gl@latest/dist.min.js"></script>
    <script src="https://cdn.maptiler.com/maptiler-sdk-js/v3.0.1/maptiler-sdk.umd.min.js"></script>
    <link href="https://cdn.maptiler.com/maptiler-sdk-js/v3.0.1/maptiler-sdk.css" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.1/nouislider.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.1/nouislider.min.js"></script>
    <style>
        html, body {margin: 0; height: 100%; overflow: hidden}
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; }
        .maplibregl-ctrl-group { display: none; }
        #controls {
            position: absolute;
            top: 10px;
            right: 10px;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 1;
            width: 280px;
            max-height: 80vh;
            overflow-y: auto;
            overflow-x: hidden;
        }
        .control-section {
            margin-bottom: 20px;
        }
        .control-section h3 {
            margin: 0 0 10px 0;
            font-size: 14px;
            font-weight: 600;
            color: #333;
        }
        .category-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }
        .category-table th {
            background: #f5f5f5;
            padding: 8px 4px;
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid #ddd;
            font-size: 11px;
        }
        .category-table th:nth-child(2), .category-table th:nth-child(3) {
            text-align: right;
        }
        .category-table th:nth-child(2), .category-table td:nth-child(2) {
            width: 60px;
            min-width: 60px;
        }
        .category-table th:nth-child(3), .category-table td:nth-child(3) {
            width: 70px;
            min-width: 70px;
        }
        .category-table td {
            padding: 6px 4px;
            border-bottom: 1px solid #eee;
            vertical-align: middle;
        }
        .category-table .source-cell {
            display: flex;
            align-items: center;
            gap: 0;
        }
        .category-table tr:hover {
            background: #f9f9f9;
        }
        .category-table .totals-row {
            font-weight: 600;
            background: #f0f0f0;
            border-top: 2px solid #ccc;
        }
        .category-table .totals-row td {
            border-bottom: none;
        }
        .category-checkbox {
            margin: 0;
            margin-right: 6px;
        }
        .category-label {
            display: flex;
            align-items: center;
            cursor: pointer;
            font-size: 11px;
        }
        .color-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            border: 1px solid #ccc;
            margin-right: 6px;
            flex-shrink: 0;
        }
        .count-cell, .capacity-cell {
            text-align: right;
            font-size: 11px;
        }
        .power-control {
            display: flex;
            flex-direction: column;
            gap: 8px;
            padding-left: 20px;
            padding-right: 20px;
        }
        .power-values {
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            color: #666;
        }
        #powerFilter {
            width: 100%;
        }
        .facility-count {
            font-size: 11px;
            color: #666;
            text-align: center;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #eee;
            line-height: 1.3;
        }
        .info-asterisk {
            color: #2196F3;
            cursor: pointer;
            margin-left: 3px;
            font-weight: bold;
            position: relative;
        }
        .info-asterisk:hover {
            color: #1976D2;
        }
        .tooltip {
            position: absolute;
            bottom: 20px;
            right: 0;
            background: #333;
            color: white;
            padding: 6px 8px;
            border-radius: 4px;
            font-size: 10px;
            width: 200px;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
            z-index: 1000;
            box-sizing: border-box;
        }
        .info-asterisk:hover .tooltip {
            opacity: 1;
        }
        .tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            right: 15px;
            border: 4px solid transparent;
            border-top-color: #333;
        }
        
        /* Loading overlay */
        #loadingOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        .loading-content {
            text-align: center;
            padding: 30px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #e0e0e0;
            border-top: 4px solid #2196F3;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Mobile responsiveness */
        @media (max-width: 480px) {
            #controls {
                width: 260px;
                font-size: 11px;
            }
            .category-table th:nth-child(2), .category-table td:nth-child(2) {
                width: 50px;
                min-width: 50px;
            }
            .category-table th:nth-child(3), .category-table td:nth-child(3) {
                width: 60px;
                min-width: 60px;
            }
            .category-table th, .category-table td {
                padding: 4px 2px;
            }
            .category-label {
                font-size: 10px;
            }
            .count-cell, .capacity-cell {
                font-size: 10px;
            }
        }
        #powerRangeSlider {
            margin: 15px 0;
        }
        /* noUiSlider customizations */
        .noUi-target {
            background: #e0e0e0;
            border-radius: 8px;
            border: none;
            height: 8px;
        }
        .noUi-connect {
            background: #2196F3;
        }
        .noUi-handle {
            width: 24px !important;
            height: 24px !important;
            border-radius: 50%;
            background: #fff;
            border: 2px solid #2196F3;
            cursor: grab;
            outline: none;
            top: -8px !important;
        }
        .noUi-handle:active {
            cursor: grabbing;
        }
        .noUi-handle:before,
        .noUi-handle:after {
            display: none;
        }
        .info-button {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #2196F3;
            color: white;
            border: none;
            cursor: pointer;
            font-size: 12px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.3s;
        }
        .info-button:hover {
            background: #1976D2;
        }
        .info-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            padding: 20px;
            box-sizing: border-box;
        }
        .info-modal.show {
            display: flex;
        }
        .info-modal-content {
            background: white;
            border-radius: 8px;
            padding: 25px;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            position: relative;
        }
        .info-modal h3 {
            margin: 0 0 15px 0;
            color: #333;
            font-size: 18px;
        }
        .info-modal h4 {
            margin: 15px 0 8px 0;
            color: #555;
            font-size: 14px;
        }
        .info-modal p, .info-modal li {
            font-size: 13px;
            line-height: 1.4;
            color: #666;
            margin: 8px 0;
        }
        .info-modal ul {
            margin: 8px 0;
            padding-left: 20px;
        }
        .info-modal a {
            color: #2196F3;
            text-decoration: none;
        }
        .info-modal a:hover {
            text-decoration: underline;
        }
        .close-modal {
            position: absolute;
            top: 10px;
            right: 15px;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #999;
            line-height: 1;
        }
        .close-modal:hover {
            color: #333;
        }
    </style>
</head>
<body>
    <div id="loadingOverlay">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <h3>Loading Swiss Energy Facilities</h3>
            <p>Fetching data for 290,000+ facilities...</p>
        </div>
    </div>

    <div id="map"></div>
    <div id="controls">
        <button class="info-button" id="infoButton">i</button>
        <div class="control-section">
            <h3>Energy Facilities</h3>
            <table id="categoryTable" class="category-table">
                <thead>
                    <tr>
                        <th>Source</th>
                        <th>Count</th>
                        <th>MW</th>
                    </tr>
                </thead>
                <tbody id="categoryTableBody">
                    <!-- Table rows will be populated dynamically -->
                </tbody>
                <tfoot>
                    <tr class="totals-row">
                        <td>Selected Totals</td>
                        <td id="totalCount" class="count-cell">-</td>
                        <td id="totalCapacity" class="capacity-cell">-</td>
                    </tr>
                </tfoot>
            </table>
        </div>
        <div class="control-section">
            <h3>Power Range: <span id="currentPowerRange">0.1 kW - 2 GW</span></h3>
            <div class="power-control">
                <div id="powerRangeSlider"></div>
                <div class="power-values">
                    <span>0.1 kW</span>
                    <span>2 GW</span>
                </div>
            </div>
        </div>
        <div class="facility-count" id="facilityCount">Loading...</div>
    </div>

    <div class="info-modal" id="infoModal">
        <div class="info-modal-content">
            <button class="close-modal" id="closeModal">&times;</button>
            <h3>Swiss Energy Facilities Map</h3>

            <h4>Instructions</h4>
            <ul>
                <li><strong>Energy facilities table:</strong> Check/uncheck energy sources to show/hide them on the map. View real-time facility counts and total capacity (MW) for each type.</li>
                <li><strong>Power range slider:</strong> Drag the handles to filter facilities by their power output.</li>
                <li><strong>Map:</strong> Mouse wheel / pinch to zoom, click+drag / tap+drag to pan, Shift+drag to change rotation and tilt. Hover over any facility for details.</li>
            </ul>

            <h4>About the data</h4>
            <p>This dataset contains all operational electricity production facilities registered in the Swiss Certificate of Origin system, including:</p>
            <ul>
                <li>All facilities with capacity greater than 30 kVA.</li>
                <li>Smaller facilities (>2 kW) voluntarily registered for certificates.</li>
                <li>Facilities subsidized via feed-in tariffs, one-time payments, or investment contributions pursuant to the 2021 Swiss Energy Act.</li>
            </ul>

            <h4>Data sources</h4>
            <p><strong>Swiss Federal Office of Energy (BFE):</strong><br>
            <a href="https://www.bfe.admin.ch/bfe/de/home/versorgung/digitalisierung-und-geoinformation/geoinformation/geodaten/produktionsanlagen/elektrizitaetsproduktionsanlagen.html" target="_blank">Electricity Production Facilities Documentation</a></p>

            <p><strong>Open Government Data Portal:</strong><br>
            <a href="https://opendata.swiss/de/dataset/elektrizitatsproduktionsanlagen/resource/3a10b118-2382-4fc1-9571-e61d0294778e" target="_blank">Dataset Download (CSV)</a></p>

            <p style="margin-top: 20px; font-size: 11px; color: #999;">Data updated regularly by the Swiss Federal Office of Energy. Some facilities lack GPS coordinates and are excluded from the map display.</p>
        </div>
    </div>

    <script>
        const MAPTILER_KEY = 'HtGwidy8WklIVYnFKMJk';
        const {Deck, ScatterplotLayer} = deck;
        let deckgl; // DeckGL instance.

        let facilities = [];             // All power facilities.
        let numFacilitiesWithCoords = 0; // Number of facilities with GPS coordinates
        let filteredFacilities = [];     // Facilities that match the current selection (category, power range)
        let mapFacilities = [];          // Facilities that match the current selection (category, power range) and have GPS coordinates
        let categories = [];             // All categories (solar, hydro, etc.)
        let selectedCategories = [];     // Categories that are currently selected
        let minPower = 0.1;              // Minimum power output (in kW)
        let maxPower = 2000000;          // Maximum power output (in kW)

        // Color palette for different categories
        const CATEGORY_COLORS = {
            'Photovoltaic': [255, 193, 7],         // Amber/Yellow - solar
            'Hydroelectric power': [33, 150, 243], // Blue - water
            'Wind energy': [76, 175, 80],          // Green - wind
            'Biomass': [139, 69, 19],              // Brown - organic
            'Natural gas': [255, 87, 34],          // Orange-red - gas
            'Waste': [158, 158, 158],              // Gray - waste
            'Nuclear energy': [156, 39, 176],      // Purple - nuclear
            'Crude oil': [96, 125, 139]            // Blue-gray - oil
        };

        function initialize() {
            maptilersdk.config.apiKey = MAPTILER_KEY;
            deckgl = new deck.DeckGL({
                container: 'map',
                map: maptilersdk,
                mapStyle: maptilersdk.MapStyle.BASIC,
                initialViewState: {
                    longitude: 8.2275,
                    latitude: 46.8182,
                    zoom: 8,
                    pitch: 0,
                    bearing: 0
                },
                controller: true,
                layers: [],
                getTooltip: ({object}) => {
                    if (!object) return null;
                    return {
                        html: `
                            <strong>${object.SubCategory}</strong><br/>
                            Power: ${object.TotalPower.toLocaleString()} kW<br/>
                            Location: ${object.Municipality}, ${object.Canton}<br/>
                            Started: ${object.BeginningOfOperation}
                        `,
                        style: {
                            backgroundColor: 'white',
                            fontSize: '12px',
                            padding: '8px',
                            borderRadius: '4px',
                            boxShadow: '0 2px 8px rgba(0,0,0,0.15)'
                        }
                    };
                }
            });
            
            loadData();
        }

        async function loadData() {
            try {
                const response = await fetch('ElectricityProductionPlant.json');
                facilities = await response.json();
                numFacilitiesWithCoords = facilities.filter(f => f.lat && f.lon).length;
                
                // Hide loading overlay
                document.getElementById('loadingOverlay').style.display = 'none';
                
                initializePowerSlider();
                setupCategoryCheckboxes();
                setupEventListeners();

                updateCategoriesAndTotals();
                updateMap();
                
                console.log(`Loaded ${facilities.length} facilities, ${numFacilitiesWithCoords} with coordinates`);
            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('loadingOverlay').innerHTML = `
                    <div class="loading-content">
                        <h3>Error Loading Data</h3>
                        <p>Failed to load facility data. Please refresh the page.</p>
                    </div>
                `;
            }
        }

        function initializePowerSlider() {
            const powerRangeSlider = document.getElementById('powerRangeSlider');
            noUiSlider.create(powerRangeSlider, {
                start: [0, 7.3], // Start at min (0.1 kW) and max (2 GW)
                connect: true,
                range: {
                    'min': 0,
                    'max': 7.3
                },
                step: 0.1
            });
        }

        function setupCategoryCheckboxes() {
            categories = [...new Set(facilities.map(f => f.SubCategory))].sort();
            selectedCategories = [...categories]; // Initialize with all categories selected.
            const container = document.getElementById('categoryTableBody');
            
            categories.forEach(category => {
                const tr = document.createElement('tr');
                
                // Source column with checkbox and color indicator
                const sourceCell = document.createElement('td');
                sourceCell.className = 'source-cell';
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.className = 'category-checkbox';
                checkbox.id = `cat-${category.replace(/\s+/g, '-')}`;
                checkbox.value = category;
                checkbox.checked = true;
                
                const label = document.createElement('label');
                label.className = 'category-label';
                label.htmlFor = checkbox.id;
                
                const colorIndicator = document.createElement('span');
                colorIndicator.className = 'color-indicator';
                const color = CATEGORY_COLORS[category] || [128, 128, 128];
                colorIndicator.style.backgroundColor = `rgb(${color.join(',')})`;
                
                const text = document.createElement('span');
                text.textContent = category;
                
                label.appendChild(colorIndicator);
                label.appendChild(text);
                sourceCell.appendChild(checkbox);
                sourceCell.appendChild(label);
                
                // Count column
                const countCell = document.createElement('td');
                countCell.className = 'count-cell';
                countCell.id = `count-${category.replace(/\s+/g, '-')}`;
                
                // Capacity column (in MW)
                const capacityCell = document.createElement('td');
                capacityCell.className = 'capacity-cell';
                capacityCell.id = `capacity-${category.replace(/\s+/g, '-')}`;
                
                tr.appendChild(sourceCell);
                tr.appendChild(countCell);
                tr.appendChild(capacityCell);
                container.appendChild(tr);
            });
        }

        function setupEventListeners() {
            // Category checkboxes - use event delegation on the table.
            document.getElementById('categoryTableBody').addEventListener('change', function(e) {
                if (e.target.type === 'checkbox') {
                    selectedCategories = Array.from(document.querySelectorAll('#categoryTableBody input[type="checkbox"]:checked')).map(cb => cb.value);
                    updateTotals();
                    updateMap();
                }
            });
            
            // Power range slider events
            const powerRangeSlider = document.getElementById('powerRangeSlider');
            powerRangeSlider.noUiSlider.on('update', function(values, handle) {
                minPower = Math.pow(10, values[0] - 1);
                maxPower = Math.pow(10, values[1] - 1);
                
                function formatPower(power) {
                    if (power >= 1000000) {
                        return `${(power / 1000000).toFixed(1)} GW`;
                    } else if (power >= 1000) {
                        return `${(power / 1000).toFixed(1)} MW`;
                    } else {
                        return `${power.toFixed(1)} kW`;
                    }
                }
                
                const minDisplay = formatPower(minPower);
                const maxDisplay = formatPower(maxPower);
                
                document.getElementById('currentPowerRange').textContent = `${minDisplay} - ${maxDisplay}`;
                updateCategoriesAndTotals();
                updateMap();
            });
        }

        function updateCategoriesAndTotals() {
            let totalCapacity = 0;
            let totalCount = 0;
            filteredFacilities = []

            categories.forEach(category => {
                const categoryFilteredFacilities = facilities.filter(f =>
                    f.SubCategory === category &&
                    f.TotalPower >= minPower &&
                    f.TotalPower <= maxPower
                );

                const count = categoryFilteredFacilities.length;
                const capacity = categoryFilteredFacilities.reduce((total, f) => total + f.TotalPower, 0) / 1000; // Convert to MW
                const countElement = document.getElementById(`count-${category.replace(/\s+/g, '-')}`);
                const capacityElement = document.getElementById(`capacity-${category.replace(/\s+/g, '-')}`);
                if (countElement) countElement.textContent = count.toLocaleString();
                if (capacityElement) capacityElement.textContent = capacity.toFixed(1);

                // Add to totals.
                if (selectedCategories.includes(category)) {
                    filteredFacilities.push(...categoryFilteredFacilities);
                    totalCapacity += capacity;
                    totalCount += count;
                }
            });

            document.getElementById('totalCount').textContent = totalCount.toLocaleString();
            document.getElementById('totalCapacity').textContent = totalCapacity.toFixed(1);
        }

        function updateTotals() {
            filteredFacilities = facilities.filter(f => 
                selectedCategories.includes(f.SubCategory) &&
                f.TotalPower >= minPower &&
                f.TotalPower <= maxPower
            );
            const totalCount = filteredFacilities.length;
            const totalCapacity = filteredFacilities.reduce((total, f) => total + f.TotalPower, 0) / 1000; // Convert to MW

            document.getElementById('totalCount').textContent = totalCount.toLocaleString();
            document.getElementById('totalCapacity').textContent = totalCapacity.toFixed(1);
        }

        function updateMap() {
            mapFacilities = filteredFacilities.filter(f => f.lat && f.lon)
            const scatterplotLayer = new ScatterplotLayer({
                id: 'facilities',
                data: mapFacilities,
                getPosition: d => [d.lon, d.lat],
                getFillColor: d => CATEGORY_COLORS[d.SubCategory] || [128, 128, 128],
                getRadius: d => Math.max(50, Math.log(d.TotalPower + 1) * 30),
                opacity: 0.7,
                pickable: true,
                radiusMinPixels: 3,
                radiusMaxPixels: 100,
                updateTriggers: {
                    getFillColor: selectedCategories,
                    getRadius: [minPower, maxPower]
                }
            });

            deckgl.setProps({ layers: [scatterplotLayer] });
            
            document.getElementById('facilityCount').innerHTML = 
                `Displaying ${mapFacilities.length.toLocaleString()} facilities on map` +
                `<span class="info-asterisk">*` +
                `<span class="tooltip">${(facilities.length - numFacilitiesWithCoords).toLocaleString()} facilities omitted from map due to missing GPS coordinates.</span>` +
                `</span>`;
        }

        // Info modal functionality
        const infoButton = document.getElementById('infoButton');
        const infoModal = document.getElementById('infoModal');
        const closeModal = document.getElementById('closeModal');

        infoButton.addEventListener('click', () => {
            infoModal.classList.add('show');
        });

        closeModal.addEventListener('click', () => {
            infoModal.classList.remove('show');
        });

        // Close modal when clicking outside
        infoModal.addEventListener('click', (e) => {
            if (e.target === infoModal) {
                infoModal.classList.remove('show');
            }
        });

        // Close modal with Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && infoModal.classList.contains('show')) {
                infoModal.classList.remove('show');
            }
        });

        // Initialize everything once data loads
        initialize();
    </script>
</body>
</html>
