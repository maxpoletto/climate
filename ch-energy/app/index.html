<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
    <title>Swiss Energy Facilities Map</title>
    <script src="https://unpkg.com/deck.gl@latest/dist.min.js"></script>
    <script src="https://cdn.maptiler.com/maptiler-sdk-js/v3.0.1/maptiler-sdk.umd.min.js"></script>
    <link href="https://cdn.maptiler.com/maptiler-sdk-js/v3.0.1/maptiler-sdk.css" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.1/nouislider.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.1/nouislider.min.js"></script>
    <style>
        html, body {margin: 0; height: 100%; overflow: hidden}
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; }
        .maplibregl-ctrl-group { display: none; }
        #controls {
            position: absolute;
            top: 10px;
            right: 10px;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 1;
            width: 280px;
            max-height: 80vh;
            overflow-y: auto;
            overflow-x: hidden;
        }
        .control-section {
            margin-bottom: 20px;
        }
        .control-section h3 {
            margin: 0 0 10px 0;
            font-size: 14px;
            font-weight: 600;
            color: #333;
        }
        .category-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }
        .category-table th {
            background: #f5f5f5;
            padding: 8px 4px;
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid #ddd;
            font-size: 11px;
        }
        .category-table th:nth-child(2), .category-table th:nth-child(3) {
            text-align: right;
        }
        .category-table th:nth-child(2), .category-table td:nth-child(2) {
            width: 60px;
            min-width: 60px;
        }
        .category-table th:nth-child(3), .category-table td:nth-child(3) {
            width: 70px;
            min-width: 70px;
        }
        .category-table td {
            padding: 6px 4px;
            border-bottom: 1px solid #eee;
            vertical-align: middle;
        }
        .category-table .source-cell {
            display: flex;
            align-items: center;
            gap: 0;
        }
        .category-table tr:hover {
            background: #f9f9f9;
        }
        .category-table .totals-row {
            font-weight: 600;
            background: #f0f0f0;
            border-top: 2px solid #ccc;
        }
        .category-table .totals-row td {
            border-bottom: none;
        }
        .category-checkbox {
            margin: 0;
            margin-right: 6px;
        }
        .category-label {
            display: flex;
            align-items: center;
            cursor: pointer;
            font-size: 11px;
        }
        .color-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            border: 1px solid #ccc;
            margin-right: 6px;
            flex-shrink: 0;
        }
        .count-cell, .capacity-cell {
            text-align: right;
            font-size: 11px;
        }
        .power-control {
            display: flex;
            flex-direction: column;
            gap: 8px;
            padding-left: 20px;
            padding-right: 20px;
        }
        .power-values {
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            color: #666;
        }
        #powerFilter {
            width: 100%;
        }
        .facility-count {
            font-size: 11px;
            color: #666;
            text-align: center;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #eee;
            line-height: 1.3;
        }
        .info-asterisk {
            color: #2196F3;
            cursor: pointer;
            margin-left: 3px;
            font-weight: bold;
            position: relative;
        }
        .info-asterisk:hover {
            color: #1976D2;
        }
        .tooltip {
            position: absolute;
            bottom: 20px;
            right: 0;
            background: #333;
            color: white;
            padding: 6px 8px;
            border-radius: 4px;
            font-size: 10px;
            width: 200px;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
            z-index: 1000;
            box-sizing: border-box;
        }
        .info-asterisk:hover .tooltip {
            opacity: 1;
        }
        .tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            right: 15px;
            border: 4px solid transparent;
            border-top-color: #333;
        }

        /* Loading overlay */
        #loadingOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        .loading-content {
            text-align: center;
            padding: 30px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #e0e0e0;
            border-top: 4px solid #2196F3;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Mobile responsiveness */
        @media (max-width: 480px) {
            #controls {
                width: 260px;
                font-size: 11px;
            }
            .category-table th:nth-child(2), .category-table td:nth-child(2) {
                width: 50px;
                min-width: 50px;
            }
            .category-table th:nth-child(3), .category-table td:nth-child(3) {
                width: 60px;
                min-width: 60px;
            }
            .category-table th, .category-table td {
                padding: 4px 2px;
            }
            .category-label {
                font-size: 10px;
            }
            .count-cell, .capacity-cell {
                font-size: 10px;
            }
        }
        #powerRangeSlider {
            margin: 15px 0;
        }
        /* noUiSlider customizations */
        .noUi-target {
            background: #e0e0e0;
            border-radius: 8px;
            border: none;
            height: 8px;
        }
        .noUi-connect {
            background: #2196F3;
        }
        .noUi-handle {
            width: 24px !important;
            height: 24px !important;
            border-radius: 50%;
            background: #fff;
            border: 2px solid #2196F3;
            cursor: grab;
            outline: none;
            top: -8px !important;
        }
        .noUi-handle:active {
            cursor: grabbing;
        }
        .noUi-handle:before,
        .noUi-handle:after {
            display: none;
        }
        .info-button {
            position: absolute;
            top: 5px;
            left: 5px;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #2196F3;
            color: white;
            border: none;
            cursor: pointer;
            font-size: 12px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.3s;
        }
        .info-button:hover {
            background: #1976D2;
        }
        .info-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            padding: 20px;
            box-sizing: border-box;
        }
        .info-modal.show {
            display: flex;
        }
        .info-modal-content {
            background: white;
            border-radius: 8px;
            padding: 25px;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            position: relative;
        }
        .info-modal h3 {
            margin: 0 0 15px 0;
            color: #333;
            font-size: 18px;
        }
        .info-modal h4 {
            margin: 15px 0 8px 0;
            color: #555;
            font-size: 14px;
        }
        .info-modal p, .info-modal li {
            font-size: 13px;
            line-height: 1.4;
            color: #666;
            margin: 8px 0;
        }
        .info-modal ul {
            margin: 8px 0;
            padding-left: 20px;
        }
        .info-modal a {
            color: #2196F3;
            text-decoration: none;
        }
        .info-modal a:hover {
            text-decoration: underline;
        }
        .close-modal {
            position: absolute;
            top: 10px;
            right: 15px;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #999;
            line-height: 1;
        }
        .close-modal:hover {
            color: #333;
        }

        /* Table view styles */
        #tableView {
            position: absolute;
            top: 0;
            bottom: 0;
            left: 0;
            right: 320px; /* Leave space for controls panel */
            background: white;
            overflow: hidden;
        }
        #tableContainer {
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        #tableHeader {
            padding: 15px 20px;
            border-bottom: 1px solid #ddd;
            background: #f9f9f9;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        #tableHeader h3 {
            margin: 0;
            color: #333;
        }
        #tableControls {
            font-size: 14px;
            color: #666;
        }
        #paginationControls {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        #paginationControls button {
            padding: 4px 8px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
        }
        #paginationControls button:hover:not(:disabled) {
            background: #f0f0f0;
        }
        #paginationControls button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        #pageInfo {
            font-size: 12px;
            color: #666;
        }
        #tableWrapper {
            flex: 1;
            overflow: auto;
        }
        #facilitiesTable {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
            table-layout: fixed;
        }
        #facilitiesTable th:nth-child(1) { width: 25%; } /* Energy Source */
        #facilitiesTable th:nth-child(2) { width: 15%; } /* Power (kW) */
        #facilitiesTable th:nth-child(3) { width: 25%; } /* Municipality */
        #facilitiesTable th:nth-child(4) { width: 12%; } /* Canton */
        #facilitiesTable th:nth-child(5) { width: 15%; } /* Started */
        #facilitiesTable th:nth-child(6) { width: 8%; }  /* GPS */
        #facilitiesTable th {
            background: #f5f5f5;
            padding: 12px 8px;
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid #ddd;
            position: sticky;
            top: 0;
            white-space: nowrap;
        }
        #facilitiesTable th.sortable {
            cursor: pointer;
            user-select: none;
        }
        #facilitiesTable th.sortable:hover {
            background: #e8e8e8;
        }
        #facilitiesTable th.numeric {
            text-align: right;
        }
        #facilitiesTable td {
            padding: 8px;
            border-bottom: 1px solid #eee;
            vertical-align: middle;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        #facilitiesTable td.numeric {
            text-align: right;
        }
        #facilitiesTable tr:hover {
            background: #f9f9f9;
        }
        .sort-indicator {
            margin-left: 5px;
            opacity: 0.5;
        }
        .sort-indicator.asc::before {
            content: 'â†‘';
            opacity: 1;
        }
        .sort-indicator.desc::before {
            content: 'â†“';
            opacity: 1;
        }
        .energy-source-cell {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .table-color-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 1px solid #ccc;
            flex-shrink: 0;
        }
        .gps-indicator {
            text-align: center;
        }
        .gps-yes {
            color: #4CAF50;
            font-weight: bold;
        }
        .gps-no {
            color: #f44336;
            font-weight: bold;
        }
        .view-toggle-btn {
            width: 100%;
            padding: 10px;
            background: #2196F3;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background-color 0.3s;
        }
        .view-toggle-btn:hover {
            background: #1976D2;
        }
    </style>
</head>
<body>
    <div id="loadingOverlay">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <h3>Loading Swiss Energy Facilities</h3>
            <p>Fetching data for 290,000+ facilities...</p>
        </div>
    </div>

    <div id="map"></div>
    <div id="tableView" style="display: none;">
        <div id="tableContainer">
            <div id="tableHeader">
                <h3>Energy Facilities Table</h3>
                <div id="tableControls">
                    <span id="tableCount">Showing 0 facilities</span>
                    <div id="paginationControls" style="margin-top: 8px;">
                        <button id="firstPage" disabled>&lt;&lt;</button>
                        <button id="prevPage" disabled>&lt;</button>
                        <span id="pageInfo">Page 1 of 1</span>
                        <button id="nextPage" disabled>&gt;</button>
                        <button id="lastPage" disabled>&gt;&gt;</button>
                    </div>
                </div>
            </div>
            <div id="tableWrapper">
                <table id="facilitiesTable">
                    <thead>
                        <tr>
                            <th data-sort="SubCategory" class="sortable">
                                Energy Source <span class="sort-indicator">â†•</span>
                            </th>
                            <th data-sort="TotalPower" class="sortable numeric">
                                Power (kW) <span class="sort-indicator">â†•</span>
                            </th>
                            <th data-sort="Municipality" class="sortable">
                                Municipality <span class="sort-indicator">â†•</span>
                            </th>
                            <th data-sort="Canton" class="sortable">
                                Canton <span class="sort-indicator">â†•</span>
                            </th>
                            <th data-sort="BeginningOfOperation" class="sortable date">
                                Started <span class="sort-indicator">â†•</span>
                            </th>
                            <th data-sort="gps" class="sortable">
                                GPS <span class="sort-indicator">â†•</span>
                            </th>
                        </tr>
                    </thead>
                    <tbody id="facilitiesTableBody">
                        <!-- Table rows will be populated dynamically -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    <div id="controls">
        <button class="info-button" id="infoButton">i</button>
        <div class="control-section">
            <button id="viewToggle" class="view-toggle-btn">ðŸ“Š Table View</button>
        </div>
        <div class="control-section">
            <h3>Energy Sources</h3>
            <table id="categoryTable" class="category-table">
                <thead>
                    <tr>
                        <th>Source</th>
                        <th>Count</th>
                        <th>MW</th>
                    </tr>
                </thead>
                <tbody id="categoryTableBody">
                    <!-- Table rows will be populated dynamically -->
                </tbody>
                <tfoot>
                    <tr class="totals-row">
                        <td>Selected Totals</td>
                        <td id="totalCount" class="count-cell">-</td>
                        <td id="totalCapacity" class="capacity-cell">-</td>
                    </tr>
                </tfoot>
            </table>
        </div>
        <div class="control-section">
            <h3>Power Range: <span id="currentPowerRange">0.1 kW - 2 GW</span></h3>
            <div class="power-control">
                <div id="powerRangeSlider"></div>
                <div class="power-values">
                    <span>0.1 kW</span>
                    <span>2 GW</span>
                </div>
            </div>
        </div>
        <div class="facility-count" id="facilityCount">Loading...</div>
    </div>

    <div class="info-modal" id="infoModal">
        <div class="info-modal-content">
            <button class="close-modal" id="closeModal">&times;</button>
            <h3>Swiss Energy Facilities Map</h3>

            <h4>Instructions</h4>
            <ul>
                <li><strong>Energy sources panel:</strong> Check/uncheck energy sources to show/hide them on the map. View real-time facility counts and total capacity (MW) for each type.</li>
                <li><strong>Power range slider:</strong> Drag the handles to filter facilities by their power output.</li>
                <li><strong>Map view:</strong> Mouse wheel / pinch to zoom, click+drag / tap+drag to pan, Shift+drag to change rotation and tilt. Hover over any facility for details. The dataset does not contain GPS coordinates for all facilities, so not all facilities are displayed on the map.</li>
                <li><strong>Table view:</strong> View all facilities, including ones without GPS coordinates. Use the pagination controls to navigate. Columns headers allow sorting.</li>
            </ul>

            <h4>About the data</h4>
            <p>This dataset contains all operational electricity production facilities registered in the Swiss Certificate of Origin system, including:</p>
            <ul>
                <li>All facilities with capacity greater than 30 kVA.</li>
                <li>Smaller facilities (>2 kW) voluntarily registered for certificates.</li>
                <li>Facilities subsidized via feed-in tariffs, one-time payments, or investment contributions pursuant to the 2021 Swiss Energy Act.</li>
            </ul>

            <h4>Data sources</h4>
            <p><strong>Swiss Federal Office of Energy (BFE):</strong><br>
            <a href="https://www.bfe.admin.ch/bfe/de/home/versorgung/digitalisierung-und-geoinformation/geoinformation/geodaten/produktionsanlagen/elektrizitaetsproduktionsanlagen.html" target="_blank">Electricity Production Facilities Documentation</a></p>

            <p><strong>Open Government Data Portal:</strong><br>
            <a href="https://opendata.swiss/de/dataset/elektrizitatsproduktionsanlagen/resource/3a10b118-2382-4fc1-9571-e61d0294778e" target="_blank">Dataset Download (CSV)</a></p>

            <p style="margin-top: 20px; font-size: 11px; color: #999;">Data updated regularly by the Swiss Federal Office of Energy. Some facilities lack GPS coordinates and are excluded from the map display.</p>
        </div>
    </div>

    <script>
        const MAPTILER_KEY = 'HtGwidy8WklIVYnFKMJk';
        const {Deck, ScatterplotLayer} = deck;
        let deckgl; // DeckGL instance.

        let facilities = [];             // All power facilities.
        let numFacilitiesWithCoords = 0; // Number of facilities with GPS coordinates
        let filteredFacilities = [];     // Facilities that match the current selection (category, power range)
        let mapFacilities = [];          // Facilities that match the current selection (category, power range) and have GPS coordinates
        let categories = [];             // All categories (solar, hydro, etc.)
        let selectedCategories = [];     // Categories that are currently selected
        let minPower = 0.1;              // Minimum power output (in kW)
        let maxPower = 2000000;          // Maximum power output (in kW)

        // Table view state
        let isTableView = false;
        let currentSort = { column: null, direction: 'asc' };
        let displayedFacilities = [];    // Currently displayed facilities in table
        let currentPage = 1;
        let facilitiesPerPage = 50;      // Show 50 facilities per page

        // Color palette for different categories
        const CATEGORY_COLORS = {
            'Photovoltaic': [255, 193, 7],         // Amber/Yellow - solar
            'Hydroelectric power': [33, 150, 243], // Blue - water
            'Wind energy': [76, 175, 80],          // Green - wind
            'Biomass': [139, 69, 19],              // Brown - organic
            'Natural gas': [255, 87, 34],          // Orange-red - gas
            'Waste': [158, 158, 158],              // Gray - waste
            'Nuclear energy': [156, 39, 176],      // Purple - nuclear
            'Crude oil': [96, 125, 139]            // Blue-gray - oil
        };

        function initialize() {
            maptilersdk.config.apiKey = MAPTILER_KEY;
            deckgl = new deck.DeckGL({
                container: 'map',
                map: maptilersdk,
                mapStyle: maptilersdk.MapStyle.BASIC,
                initialViewState: {
                    longitude: 8.2275,
                    latitude: 46.8182,
                    zoom: 8,
                    pitch: 0,
                    bearing: 0
                },
                controller: true,
                layers: [],
                getTooltip: ({object}) => {
                    if (!object) return null;
                    return {
                        html: `
                            <strong>${object.SubCategory}</strong><br/>
                            Power: ${object.TotalPower.toLocaleString()} kW<br/>
                            Location: ${object.Municipality}, ${object.Canton}<br/>
                            Started: ${object.BeginningOfOperation}
                        `,
                        style: {
                            backgroundColor: 'white',
                            fontSize: '12px',
                            padding: '8px',
                            borderRadius: '4px',
                            boxShadow: '0 2px 8px rgba(0,0,0,0.15)'
                        }
                    };
                }
            });

            loadData();
        }

        async function loadData() {
            try {
                const response = await fetch('ElectricityProductionPlant.json');
                facilities = await response.json();
                numFacilitiesWithCoords = facilities.filter(f => f.lat && f.lon).length;

                // Hide loading overlay
                document.getElementById('loadingOverlay').style.display = 'none';

                initializePowerSlider();
                setupCategoryCheckboxes();
                updateCategoriesAndTotals();
                setupEventListeners();
                updateMap();

                console.log(`Loaded ${facilities.length} facilities, ${numFacilitiesWithCoords} with coordinates`);
            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('loadingOverlay').innerHTML = `
                    <div class="loading-content">
                        <h3>Error Loading Data</h3>
                        <p>Failed to load facility data. Please refresh the page.</p>
                    </div>
                `;
            }
        }

        function initializePowerSlider() {
            const powerRangeSlider = document.getElementById('powerRangeSlider');
            noUiSlider.create(powerRangeSlider, {
                start: [0, 7.3], // Start at min (0.1 kW) and max (2 GW)
                connect: true,
                range: {
                    'min': 0,
                    'max': 7.3
                },
                step: 0.1
            });
        }

        function setupCategoryCheckboxes() {
            categories = [...new Set(facilities.map(f => f.SubCategory))].sort();
            selectedCategories = [...categories]; // Initialize with all categories selected.
            const container = document.getElementById('categoryTableBody');

            categories.forEach(category => {
                const tr = document.createElement('tr');

                // Source column with checkbox and color indicator
                const sourceCell = document.createElement('td');
                sourceCell.className = 'source-cell';
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.className = 'category-checkbox';
                checkbox.id = `cat-${category.replace(/\s+/g, '-')}`;
                checkbox.value = category;
                checkbox.checked = true;

                const label = document.createElement('label');
                label.className = 'category-label';
                label.htmlFor = checkbox.id;

                const colorIndicator = document.createElement('span');
                colorIndicator.className = 'color-indicator';
                const color = CATEGORY_COLORS[category] || [128, 128, 128];
                colorIndicator.style.backgroundColor = `rgb(${color.join(',')})`;

                const text = document.createElement('span');
                text.textContent = category;

                label.appendChild(colorIndicator);
                label.appendChild(text);
                sourceCell.appendChild(checkbox);
                sourceCell.appendChild(label);

                // Count column
                const countCell = document.createElement('td');
                countCell.className = 'count-cell';
                countCell.id = `count-${category.replace(/\s+/g, '-')}`;

                // Capacity column (in MW)
                const capacityCell = document.createElement('td');
                capacityCell.className = 'capacity-cell';
                capacityCell.id = `capacity-${category.replace(/\s+/g, '-')}`;

                tr.appendChild(sourceCell);
                tr.appendChild(countCell);
                tr.appendChild(capacityCell);
                container.appendChild(tr);
            });
        }

        function setupEventListeners() {
            // Category checkboxes - use event delegation on the table.
            document.getElementById('categoryTableBody').addEventListener('change', function(e) {
                if (e.target.type === 'checkbox') {
                    selectedCategories = Array.from(document.querySelectorAll('#categoryTableBody input[type="checkbox"]:checked')).map(cb => cb.value);
                    updateTotals();
                    updateMap();
                }
            });

            // Power range slider events
            const powerRangeSlider = document.getElementById('powerRangeSlider');
            powerRangeSlider.noUiSlider.on('update', function(values, handle) {
                minPower = Math.pow(10, values[0] - 1);
                maxPower = Math.pow(10, values[1] - 1);

                function formatPower(power) {
                    if (power >= 1000000) {
                        return `${(power / 1000000).toFixed(1)} GW`;
                    } else if (power >= 1000) {
                        return `${(power / 1000).toFixed(1)} MW`;
                    } else {
                        return `${power.toFixed(1)} kW`;
                    }
                }

                const minDisplay = formatPower(minPower);
                const maxDisplay = formatPower(maxPower);

                document.getElementById('currentPowerRange').textContent = `${minDisplay} - ${maxDisplay}`;
                updateCategoriesAndTotals();
                updateMap();
            });

            setupViewToggle();
            setupTableSorting();
            setupPagination();
        }

        function setupViewToggle() {
            const viewToggle = document.getElementById('viewToggle');
            viewToggle.addEventListener('click', toggleView);
        }

        function toggleView() {
            isTableView = !isTableView;
            const mapContainer = document.getElementById('map');
            const tableContainer = document.getElementById('tableView');
            const toggleButton = document.getElementById('viewToggle');

            if (isTableView) {
                mapContainer.style.display = 'none';
                tableContainer.style.display = 'block';
                toggleButton.textContent = 'ðŸ—ºï¸ Map View';
                updateTable();
            } else {
                mapContainer.style.display = 'block';
                tableContainer.style.display = 'none';
                toggleButton.textContent = 'ðŸ“Š Table View';
            }
        }

        function setupTableSorting() {
            const tableHeaders = document.querySelectorAll('#facilitiesTable th.sortable');
            tableHeaders.forEach(header => {
                header.addEventListener('click', () => {
                    const column = header.dataset.sort;
                    sortTable(column);
                });
            });
        }

        function setupPagination() {
            document.getElementById('firstPage').addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage = 1;
                    renderTable();
                    updatePaginationControls();
                }
            });

            document.getElementById('prevPage').addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage--;
                    renderTable();
                    updatePaginationControls();
                }
            });

            document.getElementById('nextPage').addEventListener('click', () => {
                const totalPages = Math.ceil(displayedFacilities.length / facilitiesPerPage);
                if (currentPage < totalPages) {
                    currentPage++;
                    renderTable();
                    updatePaginationControls();
                }
            });

            document.getElementById('lastPage').addEventListener('click', () => {
                const totalPages = Math.ceil(displayedFacilities.length / facilitiesPerPage);
                if (currentPage < totalPages) {
                    currentPage = totalPages;
                    renderTable();
                    updatePaginationControls();
                }
            });
        }

        function sortTable(column) {
            const direction = (currentSort.column === column && currentSort.direction === 'asc') ? 'desc' : 'asc';
            currentSort = { column, direction };

            // Clear all sort indicators
            document.querySelectorAll('.sort-indicator').forEach(indicator => {
                indicator.className = 'sort-indicator';
            });

            // Set current sort indicator
            const currentHeader = document.querySelector(`th[data-sort="${column}"] .sort-indicator`);
            currentHeader.className = `sort-indicator ${direction}`;

            // Sort the underlying facilities array - this preserves multi-column sorts
            facilities.sort((a, b) => {
                let aVal, bVal;

                switch (column) {
                    case 'TotalPower':
                        aVal = a.TotalPower || 0;
                        bVal = b.TotalPower || 0;
                        return direction === 'asc' ? aVal - bVal : bVal - aVal;

                    case 'BeginningOfOperation':
                        aVal = new Date(a.BeginningOfOperation || '1900-01-01');
                        bVal = new Date(b.BeginningOfOperation || '1900-01-01');
                        return direction === 'asc' ? aVal - bVal : bVal - aVal;

                    case 'gps':
                        aVal = (a.lat && a.lon) ? 1 : 0;
                        bVal = (b.lat && b.lon) ? 1 : 0;
                        return direction === 'asc' ? aVal - bVal : bVal - aVal;

                    default: // String columns
                        aVal = (a[column] || '').toString().toLowerCase();
                        bVal = (b[column] || '').toString().toLowerCase();
                        return direction === 'asc' ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
                }
            });

            // Re-filter and update display with the newly sorted data
            updateCategoriesAndTotals();
            updateMap();

            // Reset to first page after sorting
            currentPage = 1;
            if (isTableView) {
                updateTable();
            }
        }

        function updateTable() {
            if (!isTableView) return;

            // Use the same filtered facilities as the map (already sorted by underlying array)
            displayedFacilities = [...filteredFacilities];

            // Reset to first page when data changes
            currentPage = 1;
            renderTable();
            updatePaginationControls();

            // Update count
            document.getElementById('tableCount').textContent =
                `Showing ${displayedFacilities.length.toLocaleString()} facilities`;
        }

        function renderTable() {
            const tbody = document.getElementById('facilitiesTableBody');
            tbody.innerHTML = '';

            // Calculate pagination
            const startIndex = (currentPage - 1) * facilitiesPerPage;
            const endIndex = Math.min(startIndex + facilitiesPerPage, displayedFacilities.length);
            const facilitiesToShow = displayedFacilities.slice(startIndex, endIndex);

            facilitiesToShow.forEach(facility => {
                const row = document.createElement('tr');

                // Energy Source with color indicator
                const sourceCell = document.createElement('td');
                sourceCell.className = 'energy-source-cell';
                const colorIndicator = document.createElement('span');
                colorIndicator.className = 'table-color-indicator';
                const color = CATEGORY_COLORS[facility.SubCategory] || [128, 128, 128];
                colorIndicator.style.backgroundColor = `rgb(${color.join(',')})`;
                sourceCell.appendChild(colorIndicator);
                sourceCell.appendChild(document.createTextNode(facility.SubCategory || ''));

                // Power
                const powerCell = document.createElement('td');
                powerCell.className = 'numeric';
                powerCell.textContent = (facility.TotalPower || 0).toLocaleString();

                // Municipality
                const municipalityCell = document.createElement('td');
                municipalityCell.textContent = facility.Municipality || '';

                // Canton
                const cantonCell = document.createElement('td');
                cantonCell.textContent = facility.Canton || '';

                // Start date
                const startCell = document.createElement('td');
                startCell.textContent = facility.BeginningOfOperation || '';

                // GPS indicator
                const gpsCell = document.createElement('td');
                gpsCell.className = 'gps-indicator';
                if (facility.lat && facility.lon) {
                    gpsCell.innerHTML = '<span class="gps-yes">âœ“</span>';
                } else {
                    gpsCell.innerHTML = '<span class="gps-no">âœ—</span>';
                }

                row.appendChild(sourceCell);
                row.appendChild(powerCell);
                row.appendChild(municipalityCell);
                row.appendChild(cantonCell);
                row.appendChild(startCell);
                row.appendChild(gpsCell);
                tbody.appendChild(row);
            });
        }

        function updatePaginationControls() {
            const totalPages = Math.ceil(displayedFacilities.length / facilitiesPerPage);
            const startIndex = (currentPage - 1) * facilitiesPerPage + 1;
            const endIndex = Math.min(currentPage * facilitiesPerPage, displayedFacilities.length);

            // Update page info
            document.getElementById('pageInfo').textContent =
                `Page ${currentPage} of ${totalPages} (${startIndex}-${endIndex} of ${displayedFacilities.length.toLocaleString()})`;

            // Update button states
            document.getElementById('firstPage').disabled = currentPage <= 1;
            document.getElementById('prevPage').disabled = currentPage <= 1;
            document.getElementById('nextPage').disabled = currentPage >= totalPages;
            document.getElementById('lastPage').disabled = currentPage >= totalPages;
        }

        function updateCategoriesAndTotals() {
            // Initialize category stats
            const categoryStats = {};
            categories.forEach(category => {
                categoryStats[category] = { count: 0, capacity: 0 };
            });

            let totalCapacity = 0;
            let totalCount = 0;
            filteredFacilities = [];

            // Single pass through sorted facilities to collect stats and build filtered list
            facilities
                .filter(f => f.TotalPower >= minPower && f.TotalPower <= maxPower)
                .forEach(f => {
                    const category = f.SubCategory;

                    // Update category stats
                    if (categoryStats[category]) {
                        categoryStats[category].count++;
                        categoryStats[category].capacity += f.TotalPower / 1000; // Convert to MW
                    }

                    // Add to filtered facilities if category is selected
                    if (selectedCategories.includes(category)) {
                        filteredFacilities.push(f);
                        totalCapacity += f.TotalPower / 1000; // Convert to MW
                        totalCount++;
                    }
                });

            // Update category display elements
            categories.forEach(category => {
                const stats = categoryStats[category];
                const countElement = document.getElementById(`count-${category.replace(/\s+/g, '-')}`);
                const capacityElement = document.getElementById(`capacity-${category.replace(/\s+/g, '-')}`);
                if (countElement) countElement.textContent = stats.count.toLocaleString();
                if (capacityElement) capacityElement.textContent = stats.capacity.toFixed(1);
            });

            // Update totals
            document.getElementById('totalCount').textContent = totalCount.toLocaleString();
            document.getElementById('totalCapacity').textContent = totalCapacity.toFixed(1);
        }

        function updateTotals() {
            filteredFacilities = facilities.filter(f =>
                selectedCategories.includes(f.SubCategory) &&
                f.TotalPower >= minPower &&
                f.TotalPower <= maxPower
            );
            const totalCount = filteredFacilities.length;
            const totalCapacity = filteredFacilities.reduce((total, f) => total + f.TotalPower, 0) / 1000; // Convert to MW

            document.getElementById('totalCount').textContent = totalCount.toLocaleString();
            document.getElementById('totalCapacity').textContent = totalCapacity.toFixed(1);
        }

        function updateMap() {
            mapFacilities = filteredFacilities.filter(f => f.lat && f.lon)
            const scatterplotLayer = new ScatterplotLayer({
                id: 'facilities',
                data: mapFacilities,
                getPosition: d => [d.lon, d.lat],
                getFillColor: d => CATEGORY_COLORS[d.SubCategory] || [128, 128, 128],
                getRadius: d => Math.max(50, Math.log(d.TotalPower + 1) * 30),
                opacity: 0.7,
                pickable: true,
                radiusMinPixels: 3,
                radiusMaxPixels: 100,
                updateTriggers: {
                    getFillColor: selectedCategories,
                    getRadius: [minPower, maxPower]
                }
            });

            deckgl.setProps({ layers: [scatterplotLayer] });

            document.getElementById('facilityCount').innerHTML =
                `Displaying ${mapFacilities.length.toLocaleString()} facilities on map` +
                `<span class="info-asterisk">*` +
                `<span class="tooltip">${(facilities.length - numFacilitiesWithCoords).toLocaleString()} facilities omitted from map due to missing GPS coordinates.</span>` +
                `</span>`;

            // Update table if in table view
            updateTable();
        }

        // Info modal functionality
        const infoButton = document.getElementById('infoButton');
        const infoModal = document.getElementById('infoModal');
        const closeModal = document.getElementById('closeModal');

        infoButton.addEventListener('click', () => {
            infoModal.classList.add('show');
        });

        closeModal.addEventListener('click', () => {
            infoModal.classList.remove('show');
        });

        // Close modal when clicking outside
        infoModal.addEventListener('click', (e) => {
            if (e.target === infoModal) {
                infoModal.classList.remove('show');
            }
        });

        // Close modal with Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && infoModal.classList.contains('show')) {
                infoModal.classList.remove('show');
            }
        });

        // Initialize everything once data loads
        initialize();
    </script>
</body>
</html>
