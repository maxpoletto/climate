<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
    <title>Swiss Energy Explorer</title>
    <script src="https://unpkg.com/deck.gl@latest/dist.min.js"></script>
    <link href="https://unpkg.com/deck.gl@latest/dist/stylesheet.css" rel='stylesheet' />
    <script src="https://cdn.maptiler.com/maptiler-sdk-js/v3.0.1/maptiler-sdk.umd.min.js"></script>
    <link href="https://cdn.maptiler.com/maptiler-sdk-js/v3.0.1/maptiler-sdk.css" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.1/nouislider.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.1/nouislider.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/hammerjs@2.0.8"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
    <script>
        // Register zoom plugin once all scripts are loaded
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof Chart !== 'undefined') {
                if (Chart.Zoom) {
                    Chart.register(Chart.Zoom);
                    console.log('Registered zoom plugin from Chart.Zoom');
                } else if (window.ChartZoom) {
                    Chart.register(window.ChartZoom);
                    console.log('Registered zoom plugin from window.ChartZoom');
                } else {
                    console.log('Checking window object for zoom plugin...');
                    console.log('Available window properties:', Object.keys(window).filter(k => k.toLowerCase().includes('zoom')));
                }
            }
            initialize();
        });
    </script>
    <style>
        html, body {margin: 0; height: 100%; overflow: hidden}
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; }
        .maplibregl-ctrl-group { display: none; }
        #controls {
            position: absolute;
            top: 10px;
            right: 10px;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 1;
            width: 280px;
            max-height: 80vh;
            overflow-y: auto;
            overflow-x: hidden;
        }
        .control-section {
            margin-bottom: 20px;
        }
        .control-section h3 {
            margin: 0 0 10px 0;
            font-size: 14px;
            font-weight: 600;
            color: #333;
        }
        .category-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }
        .category-table th {
            background: #f5f5f5;
            padding: 8px 4px;
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid #ddd;
            font-size: 11px;
        }
        .category-table th:nth-child(2), .category-table th:nth-child(3) {
            text-align: right;
        }
        .category-table th:nth-child(2), .category-table td:nth-child(2) {
            width: 60px;
            min-width: 60px;
        }
        .category-table th:nth-child(3), .category-table td:nth-child(3) {
            width: 70px;
            min-width: 70px;
        }
        .category-table td {
            padding: 6px 4px;
            border-bottom: 1px solid #eee;
            vertical-align: middle;
        }
        .category-table .source-cell {
            display: flex;
            align-items: center;
            gap: 0;
        }
        .category-table tr:hover {
            background: #f9f9f9;
        }
        .category-table .totals-row {
            font-weight: 600;
            background: #f0f0f0;
            border-top: 2px solid #ccc;
        }
        .category-table .totals-row td {
            border-bottom: none;
        }
        .category-checkbox {
            margin: 0;
            margin-right: 6px;
        }
        .category-label {
            display: flex;
            align-items: center;
            cursor: pointer;
            font-size: 11px;
        }
        .color-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            border: 1px solid #ccc;
            margin-right: 6px;
            flex-shrink: 0;
        }
        .count-cell, .capacity-cell {
            text-align: right;
            font-size: 11px;
        }
        .power-control {
            display: flex;
            flex-direction: column;
            gap: 8px;
            padding-left: 20px;
            padding-right: 20px;
        }
        .power-values {
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            color: #666;
        }
        #powerFilter {
            width: 100%;
        }
        .facility-count {
            font-size: 11px;
            color: #666;
            text-align: center;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #eee;
            line-height: 1.3;
        }
        .info-asterisk {
            color: #2196F3;
            cursor: pointer;
            margin-left: 3px;
            font-weight: bold;
            position: relative;
        }
        .info-asterisk:hover {
            color: #1976D2;
        }
        .tooltip {
            position: absolute;
            bottom: 20px;
            right: 0;
            background: #333;
            color: white;
            padding: 6px 8px;
            border-radius: 4px;
            font-size: 10px;
            width: 200px;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
            z-index: 1000;
            box-sizing: border-box;
        }
        .info-asterisk:hover .tooltip {
            opacity: 1;
        }
        .tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            right: 15px;
            border: 4px solid transparent;
            border-top-color: #333;
        }

        /* Loading overlay */
        #loadingOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        .loading-content {
            text-align: center;
            padding: 30px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #e0e0e0;
            border-top: 4px solid #2196F3;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Mobile responsiveness */
        @media (max-width: 480px) {
            #controls {
                width: 260px;
                font-size: 11px;
            }
            .category-table th:nth-child(2), .category-table td:nth-child(2) {
                width: 50px;
                min-width: 50px;
            }
            .category-table th:nth-child(3), .category-table td:nth-child(3) {
                width: 60px;
                min-width: 60px;
            }
            .category-table th, .category-table td {
                padding: 4px 2px;
            }
            .category-label {
                font-size: 10px;
            }
            .count-cell, .capacity-cell {
                font-size: 10px;
            }
        }
        #powerRangeSlider {
            margin: 15px 0;
        }
        /* noUiSlider customizations */
        .noUi-target {
            background: #e0e0e0;
            border-radius: 8px;
            border: none;
            height: 8px;
        }
        .noUi-connect {
            background: #2196F3;
        }
        .noUi-handle {
            width: 24px !important;
            height: 24px !important;
            border-radius: 50%;
            background: #fff;
            border: 2px solid #2196F3;
            cursor: grab;
            outline: none;
            top: -8px !important;
        }
        .noUi-handle:active {
            cursor: grabbing;
        }
        .noUi-handle:before,
        .noUi-handle:after {
            display: none;
        }
        .info-button {
            position: fixed;
            top: 15px;
            left: 15px;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: #2196F3;
            color: white;
            border: none;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.3s;
            z-index: 1000;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }
        .info-button:hover {
            background: #1976D2;
        }
        .info-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            padding: 20px;
            box-sizing: border-box;
        }
        .info-modal.show {
            display: flex;
        }
        .info-modal-content {
            background: white;
            border-radius: 8px;
            padding: 25px;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            position: relative;
        }
        .info-modal h3 {
            margin: 0 0 15px 0;
            color: #333;
            font-size: 18px;
        }
        .info-modal h4 {
            margin: 15px 0 8px 0;
            color: #555;
            font-size: 14px;
        }
        .info-modal p, .info-modal li {
            font-size: 13px;
            line-height: 1.4;
            color: #666;
            margin: 8px 0;
        }
        .info-modal ul {
            margin: 8px 0;
            padding-left: 20px;
        }
        .info-modal a {
            color: #2196F3;
            text-decoration: none;
        }
        .info-modal a:hover {
            text-decoration: underline;
        }
        .close-modal {
            position: absolute;
            top: 10px;
            right: 15px;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #999;
            line-height: 1;
        }
        .close-modal:hover {
            color: #333;
        }

        /* Table view styles */
        #tableView {
            position: absolute;
            top: 0;
            bottom: 0;
            left: 0;
            right: 320px; /* Leave space for controls panel */
            background: white;
            overflow: hidden;
        }
        #tableContainer {
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        #tableHeader {
            padding: 15px 20px;
            border-bottom: 1px solid #ddd;
            background: #f9f9f9;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        #tableControls {
            font-size: 14px;
            color: #666;
        }
        #paginationControls {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        #paginationControls button {
            padding: 4px 8px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
        }
        #paginationControls button:hover:not(:disabled) {
            background: #f0f0f0;
        }
        #paginationControls button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        #pageInfo {
            font-size: 12px;
            color: #666;
            min-width: 180px;
            text-align: center;
        }
        #tableWrapper {
            flex: 1;
            overflow: auto;
        }
        #facilitiesTable {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
            table-layout: fixed;
        }
        #facilitiesTable th:nth-child(1) { width: 25%; } /* Energy Source */
        #facilitiesTable th:nth-child(2) { width: 15%; } /* Power (kW) */
        #facilitiesTable th:nth-child(3) { width: 25%; } /* Municipality */
        #facilitiesTable th:nth-child(4) { width: 12%; } /* Canton */
        #facilitiesTable th:nth-child(5) { width: 15%; } /* Started */
        #facilitiesTable th:nth-child(6) { width: 8%; }  /* GPS */
        #facilitiesTable th {
            background: #f5f5f5;
            padding: 12px 8px;
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid #ddd;
            position: sticky;
            top: 0;
            white-space: nowrap;
        }
        #facilitiesTable th.sortable {
            cursor: pointer;
            user-select: none;
        }
        #facilitiesTable th.sortable:hover {
            background: #e8e8e8;
        }
        #facilitiesTable th.numeric {
            text-align: right;
        }
        #facilitiesTable td {
            padding: 8px;
            border-bottom: 1px solid #eee;
            vertical-align: middle;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        #facilitiesTable td.numeric {
            text-align: right;
        }
        #facilitiesTable tr:hover {
            background: #f9f9f9;
        }
        .sort-indicator {
            margin-left: 5px;
            opacity: 0.5;
        }
        .sort-indicator.asc::before {
            content: '‚Üë';
            opacity: 1;
        }
        .sort-indicator.desc::before {
            content: '‚Üì';
            opacity: 1;
        }
        .energy-source-cell {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .table-color-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 1px solid #ccc;
            flex-shrink: 0;
        }
        .gps-indicator {
            text-align: center;
        }
        .gps-yes {
            color: #4CAF50;
            font-weight: bold;
        }
        .gps-no {
            color: #f44336;
            font-weight: bold;
        }
        .view-toggle-btn {
            width: 100%;
            padding: 10px;
            background: #2196F3;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background-color 0.3s;
        }
        .view-toggle-btn:hover {
            background: #1976D2;
        }
        #searchInput {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
            box-sizing: border-box;
            transition: border-color 0.3s;
        }
        #searchInput:focus {
            border-color: #2196F3;
            outline: none;
        }

        /* Production view styles */
        #productionView {
            position: absolute;
            top: 0;
            bottom: 0;
            left: 0;
            right: 320px; /* Leave space for controls panel */
            background: white;
            overflow: hidden;
            display: none;
        }
        #productionContainer {
            height: 100%;
            display: flex;
            flex-direction: column;
            margin-top: 40px;
        }
        #productionHeader {
            padding: 15px 20px;
            border-bottom: 1px solid #ddd;
            background: #f9f9f9;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .chart-controls {
            position: fixed;
            top: 15px;
            left: 65px; /* Start after the info button */
            right: 320px; /* Leave space for the controls panel */
            background: white;
            padding: 5px 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            overflow: hidden; /* Cut off content if window is too narrow */
            white-space: nowrap; /* Prevent text wrapping */
        }
        .chart-help {
            font-size: 11px;
            color: #666;
            line-height: 1.3;
            margin: 0;
        }
        .reset-zoom-btn {
            padding: 6px 12px;
            margin-left: 5px;
            background: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: background-color 0.3s;
        }
        .reset-zoom-btn:hover {
            background: #e8e8e8;
        }
        #productionChartContainer {
            flex: 1;
            padding: 20px;
            overflow: hidden;
        }
        #productionChart {
            width: 100% !important;
            height: 100% !important;
            user-select: none;
            -moz-user-select: none;
            -webkit-user-select: none;
            -ms-user-select: none;
        }
        .mode-toggle-group {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
        }
        .mode-toggle-btn {
            width: 50%;
            padding: 8px;
            background: #f5f5f5;
            color: #333;
            border: 1px solid #ddd;
            border-radius: 5px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.3s;
            margin-bottom: 8px;
        }
        .mode-toggle-btn:hover:not(.active) {
            background: #e8e8e8;
        }
        .mode-toggle-btn.active {
            background: #2196F3;
            color: white;
            border-color: #1976D2;
        }
        .mode-toggle-btn.active:hover {
            background: #1976D2;
        }
        .production-controls {
            display: none;
        }
        .production-controls.active {
            display: block;
        }
        #retryButton {
            padding: 10px 20px;
            background: #2196F3;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div id="loadingOverlay">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <h3>Loading Swiss energy data</h3>
            <p>Fetching data for 290,000+ facilities and 4,000+ production days...</p>
        </div>
    </div>

    <button class="info-button" id="infoButton">?</button>
    <div id="map"></div>
    <div id="tableView" style="display: none;">
        <div id="tableContainer">
            <div id="tableHeader">
                <div id="tableControls">
                    <div id="paginationControls">
                        <button id="firstPage" disabled>&lt;&lt;</button>
                        <button id="prevPage" disabled>&lt;</button>
                        <span id="pageInfo">Page <span id="currentPageNumber" style="cursor: pointer; text-decoration: underline; color: #2196F3;">1</span> of <span id="totalPages">1</span></span>
                        <button id="nextPage" disabled>&gt;</button>
                        <button id="lastPage" disabled>&gt;&gt;</button>
                    </div>
                </div>
            </div>
            <div id="tableWrapper">
                <table id="facilitiesTable">
                    <thead>
                        <tr>
                            <th data-sort="SubCategory" class="sortable">
                                Energy Source <span class="sort-indicator">‚Üï</span>
                            </th>
                            <th data-sort="TotalPower" class="sortable numeric">
                                Power (kW) <span class="sort-indicator">‚Üï</span>
                            </th>
                            <th data-sort="Municipality" class="sortable">
                                Municipality <span class="sort-indicator">‚Üï</span>
                            </th>
                            <th data-sort="Canton" class="sortable">
                                Canton <span class="sort-indicator">‚Üï</span>
                            </th>
                            <th data-sort="BeginningOfOperation" class="sortable date">
                                Started <span class="sort-indicator">‚Üï</span>
                            </th>
                            <th data-sort="gps" class="sortable">
                                GPS <span class="sort-indicator">‚Üï</span>
                            </th>
                        </tr>
                    </thead>
                    <tbody id="facilitiesTableBody">
                        <!-- Table rows will be populated dynamically -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    <div id="productionView">
        <div class="chart-controls">
            <span class="chart-help">
                Zoom: mouse wheel or pinch or -/_/+/= keys ‚Ä¢ Pan: tap/click + drag or arrow keys.<br/>
                Bars adapt: daily‚Üíweekly‚Üímonthly‚Üíquarterly
            </span>
            <button id="resetZoom" class="reset-zoom-btn">Reset Zoom</button>
        </div>
        <div id="productionContainer">
            <div id="productionChartContainer">
                <canvas id="productionChart"></canvas>
            </div>
        </div>
    </div>
    <div id="controls">
        <div class="control-section">
            <div class="mode-toggle-group">
                <button id="facilitiesMode" class="mode-toggle-btn active">‚öôÔ∏è Facilities</button>
                <button id="productionMode" class="mode-toggle-btn">‚ö° Production</button>
            </div>
        </div>
        <div class="control-section facilities-controls">
            <button id="viewToggle" class="view-toggle-btn">üìä Table View</button>
        </div>
        <div class="control-section facilities-controls">
            <h3>Energy Sources</h3>
            <table id="categoryTable" class="category-table">
                <thead>
                    <tr>
                        <th>Source</th>
                        <th>Count</th>
                        <th>MW</th>
                    </tr>
                </thead>
                <tbody id="categoryTableBody">
                    <!-- Table rows will be populated dynamically -->
                </tbody>
                <tfoot>
                    <tr class="totals-row">
                        <td>Selected Totals</td>
                        <td id="totalCount" class="count-cell">-</td>
                        <td id="totalCapacity" class="capacity-cell">-</td>
                    </tr>
                </tfoot>
            </table>
        </div>
        <div class="control-section facilities-controls">
            <h3>Power Range: <span id="currentPowerRange">0.1 kW - 2 GW</span></h3>
            <div class="power-control">
                <div id="powerRangeSlider"></div>
                <div class="power-values">
                    <span>0.1 kW</span>
                    <span>2 GW</span>
                </div>
            </div>
        </div>
        <div class="control-section facilities-controls">
            <h3>Search</h3>
            <input type="text" id="searchInput" placeholder="(e.g., 'canton:vs', 'year:2021', 'z√ºrich', ...)" />
        </div>
        <div class="control-section production-controls">
            <h3>Energy Sources</h3>
            <table id="productionCategoryTable" class="category-table">
                <thead>
                    <tr>
                        <th>Source</th>
                        <th>Mean<br/>GWh/day</th>
                    </tr>
                </thead>
                <tbody id="productionCategoryTableBody">
                    <!-- Table rows will be populated dynamically -->
                </tbody>
            </table>
        </div>
        <div class="facility-count" id="facilityCount">Loading...</div>
    </div>

    <div class="info-modal" id="infoModal">
        <div class="info-modal-content">
            <button class="close-modal" id="closeModal">&times;</button>
            <h3>Swiss Energy Explorer</h3>

            <p>This tool displays electricity generation facilities in Switzerland and daily Swiss electricity production since 2015.</p>

            <h4>Instructions</h4>
            <ul>
                <li><strong>Facilities / Production mode toggle</strong>
                    <p>Click the <strong>Facilities</strong> or <strong>Production</strong> button to switch between facilities and production mode.</p>
                </li>
                <li><strong>Table / Map view toggle</strong>
                    <p>Within facilities mode, click <strong>Table View</strong> to switch from map to table, or <strong>Map View</strong> to switch from table to map.</p>
                </li>
                <li><strong>Energy sources panel</strong>
                    <p>Controls what facilities are displayed and counted.</p>
                    <ul>
                        <li>Check/uncheck energy source types (biomass, hydro, etc.).</li>
                        <li>In facilities mode, drag the handles of the power range slider to filter facilities by their power output.</li>
                        <li>In facilities mode, use the search input to filter facilities by name, municipality, canton, or energy source. Supports case-insensitive free-form substring match, e.g., 'vs hydro 2021',
                            and also the keywords 'canton' (e.g., 'canton:be'),'city' (e.g., 'city:z√ºrich'), and 'year' (tip: e.g., 'year:202' matches any facility started in the 2020s).
                        </li>
                    </ul>
                    <p>Counters update in real time as you change the filters.</p>
                </li>
                <li><strong>Facilities map view</strong>
                    <p>Zoom: mouse wheel or pinch or -/_/+/= keys. Pan: tap/click + drag. Rotate/tilt: Shift+drag. Hover over any facility for details.</p>
                    <p>The dataset does not contain GPS coordinates for all facilities, so not all facilities are displayed on the map.</p>
                </li>
                <li><strong>Facilities table view</strong>
                    <p>View all facilities, including ones without GPS coordinates.</p>
                    <p>Use the pagination controls to navigate (click on the page number to jump to a specific page).</p>
                    <p>Use the column headers to sort.</p>
                </li>
                <li><strong>Production mode</strong>
                    <p>The chart by default shows the entire time range (2015 to present) broken down by quarters.</p>
                    <p>Zoom: mouse wheel or pinch or -/_/+/= keys. Pan: tap/click + drag or arrow keys. Summary statistics in the sources panel update as you move around.
                        Bars rescale (quarters ‚Üí months ‚Üí weeks ‚Üí days) as you zoom in.</p>
                    <p>Hover over any bar to see details for the corresponding time period.</p>
                </li>
            </ul>

            <h4>About the data</h4>
            <p>The facilities dataset contains all operational electricity production facilities registered in the Swiss Certificate of Origin system, including:</p>
            <ul>
                <li>All facilities with capacity greater than 30 kVA.</li>
                <li>Smaller facilities (>2 kW) voluntarily registered for certificates.</li>
                <li>Facilities subsidized via feed-in tariffs, one-time payments, or investment contributions pursuant to the 2021 Swiss Energy Act.</li>
            </ul>

            <p>The production data contains aggregate energy production broken down by day and energy source, starting on 2015-01-01.</p>
            <p><strong>Unfortunately, the production source types are not exactly the same as those in the facilities dataset, and there are no public per-facility production records.</strong></p>

            <p>Facilities data is updated quarterly. Production data is updated weekly (with 1-day granularity).</p>

            <h4>Data sources</h4>
            <p><strong>Swiss Federal Office of Energy (BFE):</strong>
            <a href="https://www.bfe.admin.ch/bfe/de/home/versorgung/digitalisierung-und-geoinformation/geoinformation/geodaten/produktionsanlagen/elektrizitaetsproduktionsanlagen.html" target="_blank">Electricity Production Facilities Documentation</a></p>

            <p><strong>BFE facilities data (Open Government Data Portal):</strong>
            <a href="https://opendata.swiss/de/dataset/elektrizitatsproduktionsanlagen/resource/3a10b118-2382-4fc1-9571-e61d0294778e" target="_blank">CSV</a></p>

            <p><strong>Swissgrid production data (Open Government Data Portal):</strong>
            <a href="https://www.uvek-gis.admin.ch/BFE/ogd/104/ogd104_stromproduktion_swissgrid.csv" target="_blank">CSV</a></p>
        </div>
    </div>

    <script>
        let MAPTILER_KEY = null;         // Load from file.
        const {Deck, ScatterplotLayer} = deck;
        let deckgl;                      // DeckGL instance.

        // Global state object
        const appState = {
            // Top-level toggle, facilities vs production mode
            isProductionMode: false,

            // Facilities mode state
            isTableView: false,
            currentSort: { column: 'TotalPower', direction: 'desc' },
            currentPage: 1,
            selectedCategories: [],
            minPower: 0.1,
            maxPower: 2000000,
            searchTokens: [],

            // Production mode state
            selectedProductionCategories: [],

            // Map view state
            mapView: {
                latitude: 46.8182,
                longitude: 8.2275,
                zoom: 8
            },

            // Production chart state
            productionChart: {
                xmin: null,
                xmax: null
            }
        };

        let facilities = [];             // All power facilities.
        let numFacilitiesWithCoords = 0; // Number of facilities with GPS coordinates
        let filteredFacilities = [];     // Facilities that match the current selection (category, power range)
        let mapFacilities = [];          // Facilities that match the current selection (category, power range) and have GPS coordinates
        let categories = [];             // All categories (solar, hydro, etc.)
        let searchTimeout = null;        // Debounce timeout for search

        // Table view state
        let displayedFacilities = [];    // Currently displayed facilities in table
        const facilitiesPerPage = 50;    // Show 50 facilities per page

        // Production data state
        let productionData = [];         // Historical production data
        let productionChart = null;      // Chart.js instance
        let productionCategories = [     // Production categories (from prod.json.gz)
            'Hydro (pumped)',
            'Hydro (river)',
            'Nuclear',
            'Photovoltaic',
            'Thermal',
            'Wind'
        ];

        // Color palette for different categories
        const CATEGORY_COLORS = {
            'Photovoltaic': [255, 193, 7],         // Amber/Yellow - solar
            'Hydroelectric power': [33, 150, 243], // Blue - water
            'Wind energy': [76, 175, 80],          // Green - wind
            'Biomass': [139, 69, 19],              // Brown - organic
            'Natural gas': [255, 87, 34],          // Orange-red - gas
            'Waste': [100, 100, 100],              // Gray - waste
            'Nuclear energy': [156, 39, 176],      // Purple - nuclear
            'Crude oil': [96, 125, 139]            // Blue-gray - oil
        };

        // Color palette for production categories (same colors as categories for matching categories)
        const PRODUCTION_COLORS = {
            'Hydro (pumped)': [33, 150, 243],      // Blue
            'Hydro (river)': [21, 101, 192],       // Darker blue
            'Nuclear': [156, 39, 176],             // Purple
            'Photovoltaic': [255, 193, 7],         // Amber/Yellow
            'Thermal': [255, 87, 34],              // Orange-red
            'Wind': [76, 175, 80]                  // Green
        };

        // Time unit names for production chart title
        const timeUnitNames = {
            'day': 'Daily',
            'week': 'Weekly',
            'month': 'Monthly',
            'quarter': 'Quarterly'
        };

        async function loadMapTilerKey() {
            const response = await fetch('maptiler-key.txt');
            if (!response.ok) {
                throw new Error(`Failed to load MapTiler key: ${response.status} ${response.statusText}`);
            }
            const key = await response.text();
            return key.trim();
        }

        async function initialize() {
            try {
                MAPTILER_KEY = await loadMapTilerKey();
            } catch (error) {
                console.error('Failed to load MapTiler key:', error);
                const loadingOverlay = document.getElementById('loadingOverlay');
                loadingOverlay.innerHTML = `
                    <div class="loading-content">
                        <h3>‚ö†Ô∏è MapTiler API Key Missing</h3>
                        <p><strong>Cannot load map tiles.</strong></p>
                        <p style="font-size: 12px; color: #666; margin-top: 15px;">Contact maxp@maxp.net for help.</p>
                    </div>
                `;
                return;
            }

            maptilersdk.config.apiKey = MAPTILER_KEY;
            deckgl = new deck.DeckGL({
                container: 'map',
                map: maptilersdk,
                mapStyle: maptilersdk.MapStyle.BASIC,
                initialViewState: {
                    longitude: appState.mapView.longitude,
                    latitude: appState.mapView.latitude,
                    zoom: appState.mapView.zoom,
                    pitch: 0,
                    bearing: 0
                },
                controller: true,
                layers: [],
                onViewStateChange: ({viewState}) => {
                    // Update map view state when map is moved
                    appState.mapView.latitude = viewState.latitude;
                    appState.mapView.longitude = viewState.longitude;
                    appState.mapView.zoom = viewState.zoom;
                },
                widgets: [
                    new deck.FullscreenWidget({
                        id: 'fullscreen-control',
                        style: {
                            // Style to center-align with help button.
                            position: 'fixed',
                            top: '70px',
                            left: '19px',
                            padding: '0px',
                            margin: '0px',
                            zIndex: 1000
                        }
                    }),
                    new deck.ZoomWidget({
                        id: 'zoom-control',
                        orientation: 'vertical',
                        style: {
                            // Style to center-align with help button.
                            position: 'fixed',
                            top: '110px',
                            left: '19px',
                            padding: '0px',
                            margin: '0px',
                            zIndex: 1000
                        }
                    })
                ],
                getTooltip: ({object}) => {
                    if (!object) return null;
                    return {
                        html: `
                            <strong>${object.SubCategory}</strong><br/>
                            Power: ${object.TotalPower.toLocaleString()} kW<br/>
                            Location: ${object.Municipality}, ${object.Canton}<br/>
                            Started: ${object.BeginningOfOperation}
                        `,
                        style: {
                            backgroundColor: 'white',
                            fontSize: '12px',
                            padding: '8px',
                            borderRadius: '4px',
                            boxShadow: '0 2px 8px rgba(0,0,0,0.15)'
                        }
                    };
                }
            });

            loadData();
        }

        function initializeUI() {
            initializePowerSlider();
            setupCategoryCheckboxes();
            setupProductionControls();
            setDefaultSort();
            updateCategoriesAndTotals();
            setupEventListeners();
            updateTableOrMap();
        }

        async function loadData() {
            try {
                // Add daily timestamp to limit caching time to one day.
                const t = new Date();
                const ts = new Date(t.getFullYear(), t.getMonth(), t.getDate()).getTime();

                const facilitiesResponse = await fetch(`data/facilities.json?v=${ts}`);
                if (!facilitiesResponse.ok) {
                    throw new Error(`Failed to load facilities data: ${facilitiesResponse.status} ${facilitiesResponse.statusText}`);
                }
                facilities = await facilitiesResponse.json();
                numFacilitiesWithCoords = facilities.filter(f => f.lat && f.lon).length;

                const productionResponse = await fetch(`data/production.json?v=${ts}`);
                if (!productionResponse.ok) {
                    throw new Error(`Failed to load production data: ${productionResponse.status} ${productionResponse.statusText}`);
                }
                productionData = await productionResponse.json();
                productionData.map(d => {
                    const [year, month, day] = d.date.split('-').map(Number);
                    d.date = new Date(year, month - 1, day); // Parse as local time.
                });
                appState.selectedProductionCategories = [...productionCategories];

                // Hide loading overlay after successful data load
                document.getElementById('loadingOverlay').style.display = 'none';

                initializeUI();

                console.log(`Loaded ${facilities.length} facilities, ${numFacilitiesWithCoords} with coordinates`);
                console.log(`Loaded ${productionData.length} days of production data`);
            } catch (error) {
                console.error('Error loading data:', error);

                // Show error overlay and halt app initialization
                const loadingOverlay = document.getElementById('loadingOverlay');
                loadingOverlay.innerHTML = `
                    <div class="loading-content">
                        <h3>‚ö†Ô∏è Error Loading Data</h3>
                        <p><strong>Failed to load energy data.</strong></p>
                        <p style="font-size: 12px; color: #666; margin-top: 15px;">
                            ${error.message}
                        </p>
                        <p style="margin-top: 20px;">
                            <button id="retryButton" onclick="window.location.reload()">Retry</button>
                        </p>
                    </div>
                `;
                loadingOverlay.style.display = 'flex';
                return;
            }
        }

        function initializePowerSlider() {
            const powerRangeSlider = document.getElementById('powerRangeSlider');
            noUiSlider.create(powerRangeSlider, {
                start: [0, 7.3], // Start at min (0.1 kW) and max (2 GW)
                connect: true,
                range: {
                    'min': 0,
                    'max': 7.3
                },
                step: 0.1
            });
        }

        function facilityMatchesSearch(f) {
            if (appState.searchTokens.length === 0) return true;

            // Fields to search: Energy Source, Power, Municipality, Canton, Date started
            const searchableText = [
                f.SubCategory || '',
                (f.TotalPower || '').toString(),
                f.BeginningOfOperation || '',
                'city:' + (f.Municipality || ''),
                'canton:' + (f.Canton || ''),
                'year:' + (f.BeginningOfOperation || '').slice(0, 4),
            ].join(' ').toLowerCase();

            // All tokens must be found as substrings
            return appState.searchTokens.every(token => searchableText.includes(token));
        }

        function sortFacilities(column, direction) {
            facilities.sort((a, b) => {
                let aVal, bVal;

                switch (column) {
                    case 'TotalPower':
                        aVal = a.TotalPower || 0;
                        bVal = b.TotalPower || 0;
                        return direction === 'asc' ? aVal - bVal : bVal - aVal;

                    case 'BeginningOfOperation':
                        aVal = new Date(a.BeginningOfOperation || '1900-01-01');
                        bVal = new Date(b.BeginningOfOperation || '1900-01-01');
                        return direction === 'asc' ? aVal - bVal : bVal - aVal;

                    case 'gps':
                        aVal = (a.lat && a.lon) ? 1 : 0;
                        bVal = (b.lat && b.lon) ? 1 : 0;
                        return direction === 'asc' ? aVal - bVal : bVal - aVal;

                    default: // String columns
                        aVal = (a[column] || '').toString().toLowerCase();
                        bVal = (b[column] || '').toString().toLowerCase();
                        return direction === 'asc' ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
                }
            });
        }

        function setDefaultSort() {
            sortFacilities('Municipality', 'asc');
            sortFacilities('TotalPower', 'desc');
            const powerHeader = document.querySelector('th[data-sort="TotalPower"] .sort-indicator');
            if (powerHeader) {
                powerHeader.className = 'sort-indicator desc';
            }
        }

        function setupCategoryCheckboxes() {
            categories = [...new Set(facilities.map(f => f.SubCategory))].sort();
            appState.selectedCategories = [...categories]; // Initialize with all categories selected.
            const container = document.getElementById('categoryTableBody');
            container.innerHTML = '';

            // Select/Deselect all checkbox
            const allCheckbox = document.createElement('input');
            allCheckbox.type = 'checkbox';
            allCheckbox.className = 'category-checkbox';
            allCheckbox.id = 'cat-select-all';
            allCheckbox.checked = true;
            const allLabel = document.createElement('label');
            allLabel.htmlFor = 'cat-select-all';
            allLabel.textContent = 'Select/Deselect All';
            const allTd = document.createElement('td');
            allTd.colSpan = 3;
            allTd.appendChild(allCheckbox);
            allTd.appendChild(allLabel);
            let tr = document.createElement('tr');
            tr.appendChild(allTd);
            container.appendChild(tr);

            categories.forEach(category => {
                tr = document.createElement('tr');

                // Source column with checkbox and color indicator
                const sourceCell = document.createElement('td');
                sourceCell.className = 'source-cell';
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.className = 'category-checkbox';
                checkbox.id = `cat-${category.replace(/\s+/g, '-')}`;
                checkbox.value = category;
                checkbox.checked = true;

                const label = document.createElement('label');
                label.className = 'category-label';
                label.htmlFor = checkbox.id;

                const colorIndicator = document.createElement('span');
                colorIndicator.className = 'color-indicator';
                const color = CATEGORY_COLORS[category] || [128, 128, 128];
                colorIndicator.style.backgroundColor = `rgb(${color.join(',')})`;

                const text = document.createElement('span');
                text.textContent = category;

                label.appendChild(colorIndicator);
                label.appendChild(text);
                sourceCell.appendChild(checkbox);
                sourceCell.appendChild(label);

                // Count column
                const countCell = document.createElement('td');
                countCell.className = 'count-cell';
                countCell.id = `count-${category.replace(/\s+/g, '-')}`;

                // Capacity column (in MW)
                const capacityCell = document.createElement('td');
                capacityCell.className = 'capacity-cell';
                capacityCell.id = `capacity-${category.replace(/\s+/g, '-')}`;

                tr.appendChild(sourceCell);
                tr.appendChild(countCell);
                tr.appendChild(capacityCell);
                container.appendChild(tr);
            });
        }

        function updateTableOrMap() {
            if (appState.isTableView) {
                updateTable();
            } else {
                updateMap();
            }
        }
        function setupProductionControls() {
            const container = document.getElementById('productionCategoryTableBody');
            container.innerHTML = '';

            // Select/Deselect all checkbox
            const allCheckbox = document.createElement('input');
            allCheckbox.type = 'checkbox';
            allCheckbox.className = 'category-checkbox';
            allCheckbox.id = 'prod-cat-select-all';
            allCheckbox.checked = true;
            const allLabel = document.createElement('label');
            allLabel.htmlFor = 'prod-cat-select-all';
            allLabel.textContent = 'Select/Deselect All';
            const allTd = document.createElement('td');
            allTd.colSpan = 2;
            allTd.appendChild(allCheckbox);
            allTd.appendChild(allLabel);
            let tr = document.createElement('tr');
            tr.appendChild(allTd);
            container.appendChild(tr);

            productionCategories.forEach((category, index) => {
                tr = document.createElement('tr');

                // Source column with checkbox and color indicator
                const sourceCell = document.createElement('td');
                sourceCell.className = 'source-cell';
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.className = 'category-checkbox';
                checkbox.id = `prod-cat-${index}`;
                checkbox.value = category;
                checkbox.checked = true;

                const label = document.createElement('label');
                label.className = 'category-label';
                label.htmlFor = checkbox.id;

                const colorIndicator = document.createElement('span');
                colorIndicator.className = 'color-indicator';
                const color = PRODUCTION_COLORS[category] || [128, 128, 128];
                colorIndicator.style.backgroundColor = `rgb(${color.join(',')})`;

                const text = document.createElement('span');
                text.textContent = category;

                label.appendChild(colorIndicator);
                label.appendChild(text);
                sourceCell.appendChild(checkbox);
                sourceCell.appendChild(label);

                // Average daily production column
                const avgCell = document.createElement('td');
                avgCell.className = 'count-cell';
                avgCell.id = `prod-avg-${index}`;

                tr.appendChild(sourceCell);
                tr.appendChild(avgCell);
                container.appendChild(tr);
            });
            updateProductionStats(0, Infinity);
        }

        function updateProductionStats(minDate, maxDate) {
            const totals = new Array(6).fill(0);
            let count = 0;

            productionData.forEach(record => {
                if (record.date < minDate || record.date > maxDate) return;
                record.prod.forEach((value, index) => {
                    totals[index] += value;
                });
                count++;
            });

            productionCategories.forEach((category, index) => {
                const avgElement = document.getElementById(`prod-avg-${index}`);
                if (avgElement) {
                    const avg = totals[index] / count;
                    avgElement.textContent = avg.toFixed(1);
                }
            });
        }

        function setupEventListeners() {
            setupFacilityCategories();
            setupFacilityMapControls();
            setupFacilityViewToggle();
            setupFacilityTableControls();
            setupModeToggle();
            setupProductionCategories();
            setupProductionControls();
        }

        function setupFacilityCategories() {
            const allCheckbox = document.getElementById('cat-select-all');
            document.getElementById('categoryTableBody').addEventListener('change', function(e) {
                if (e.target.type === 'checkbox') {
                    if (e.target.id === 'cat-select-all') {
                        // Select/deselect all
                        const checked = e.target.checked;
                        document.querySelectorAll('#categoryTableBody input[type="checkbox"]').forEach(cb => {
                            if (cb.id !== 'cat-select-all') cb.checked = checked;
                        });
                        appState.selectedCategories = checked ? [...categories] : [];
                    } else {
                        appState.selectedCategories = Array.from(document.querySelectorAll('#categoryTableBody input[type="checkbox"]:not(#cat-select-all):checked')).map(cb => cb.value);
                        // Sync select-all checkbox
                        const allChecked = appState.selectedCategories.length === categories.length;
                        allCheckbox.checked = allChecked;
                    }
                    updateTotals();
                    updateTableOrMap();
                }
            });
        }

        function setupFacilityMapControls() {
            const powerRangeSlider = document.getElementById('powerRangeSlider');
            powerRangeSlider.noUiSlider.on('update', function(values, handle) {
                appState.minPower = Math.pow(10, values[0] - 1);
                appState.maxPower = Math.pow(10, values[1] - 1);

                function formatPower(power) {
                    if (power >= 1000000) {
                        return `${(power / 1000000).toFixed(1)} GW`;
                    } else if (power >= 1000) {
                        return `${(power / 1000).toFixed(1)} MW`;
                    } else {
                        return `${power.toFixed(1)} kW`;
                    }
                }

                const minDisplay = formatPower(appState.minPower);
                const maxDisplay = formatPower(appState.maxPower);

                document.getElementById('currentPowerRange').textContent = `${minDisplay} - ${maxDisplay}`;
                updateCategoriesAndTotals();
                updateTableOrMap();
            });

            const searchInput = document.getElementById('searchInput');
            searchInput.addEventListener('input', (e) => {
                const searchText = e.target.value;

                // Use a timeout to debounce search (reduce expensive filter computations).
                if (searchTimeout) {
                    clearTimeout(searchTimeout);
                }
                searchTimeout = setTimeout(() => {
                    appState.searchTokens = searchText.toLowerCase().split(/\s+/).filter(token => token.length > 0);
                    updateCategoriesAndTotals();
                    updateTableOrMap();
                }, 300); // 300ms delay
            });
        }

        function setupFacilityViewToggle() {
            const viewToggle = document.getElementById('viewToggle');
            viewToggle.addEventListener('click', () => {
                if (appState.isProductionMode) return; // No effect in production mode

                appState.isTableView = !appState.isTableView;
                const mapContainer = document.getElementById('map');
                const tableContainer = document.getElementById('tableView');
                const toggleButton = document.getElementById('viewToggle');

                if (appState.isTableView) {
                    mapContainer.style.display = 'none';
                    tableContainer.style.display = 'block';
                    toggleButton.textContent = 'üó∫Ô∏è Map View';
                    updateTable();
                } else {
                    mapContainer.style.display = 'block';
                    tableContainer.style.display = 'none';
                    toggleButton.textContent = 'üìä Table View';
                    updateMap();
                }
            });
        }

        function setupFacilityTableControls() {
            const tableHeaders = document.querySelectorAll('#facilitiesTable th.sortable');
            tableHeaders.forEach(header => {
                header.addEventListener('click', () => {
                    const column = header.dataset.sort;
                    sortTable(column);
                });
            });

            document.getElementById('firstPage').addEventListener('click', () => {
                if (appState.currentPage > 1) {
                    appState.currentPage = 1;
                    renderTable();
                }
            });

            document.getElementById('prevPage').addEventListener('click', () => {
                if (appState.currentPage > 1) {
                    appState.currentPage--;
                    renderTable();
                }
            });

            document.getElementById('nextPage').addEventListener('click', () => {
                const totalPages = Math.ceil(displayedFacilities.length / facilitiesPerPage);
                if (appState.currentPage < totalPages) {
                    appState.currentPage++;
                    renderTable();
                }
            });

            document.getElementById('lastPage').addEventListener('click', () => {
                const totalPages = Math.ceil(displayedFacilities.length / facilitiesPerPage);
                if (appState.currentPage < totalPages) {
                    appState.currentPage = totalPages;
                    renderTable();
                }
            });

            // Page number click => inline input
            document.getElementById('currentPageNumber').addEventListener('click', handlePageNumberClick);
        }

        function setupModeToggle() {
            const facilitiesBtn = document.getElementById('facilitiesMode');
            const productionBtn = document.getElementById('productionMode');

            facilitiesBtn.addEventListener('click', () => {
                if (!appState.isProductionMode) return;

                appState.isProductionMode = false;
                facilitiesBtn.classList.add('active');
                productionBtn.classList.remove('active');

                // Show facilities controls, hide production controls
                document.querySelectorAll('.facilities-controls').forEach(el => el.style.display = 'block');
                document.querySelectorAll('.production-controls').forEach(el => el.style.display = 'none');
                document.getElementById('facilityCount').style.display = 'block';

                // Show appropriate view
                document.getElementById('productionView').style.display = 'none';
                if (appState.isTableView) {
                    document.getElementById('tableView').style.display = 'block';
                    document.getElementById('map').style.display = 'none';
                } else {
                    document.getElementById('tableView').style.display = 'none';
                    document.getElementById('map').style.display = 'block';
                }
            });

            productionBtn.addEventListener('click', () => {
                if (appState.isProductionMode) return;

                appState.isProductionMode = true;
                productionBtn.classList.add('active');
                facilitiesBtn.classList.remove('active');

                // Hide facilities controls, show production controls
                document.querySelectorAll('.facilities-controls').forEach(el => el.style.display = 'none');
                document.querySelectorAll('.production-controls').forEach(el => el.style.display = 'block');
                document.getElementById('facilityCount').style.display = 'none';

                // Show production view
                document.getElementById('map').style.display = 'none';
                document.getElementById('tableView').style.display = 'none';
                document.getElementById('productionView').style.display = 'block';

                // Initialize or update the chart
                updateProductionChart();
            });
        }

        function setupProductionCategories() {
            const allCheckbox = document.getElementById('prod-cat-select-all');
            document.getElementById('productionCategoryTableBody').addEventListener('change', function(e) {
                if (e.target.type === 'checkbox') {
                    if (e.target.id === 'prod-cat-select-all') {
                        // Select/deselect all
                        const checked = e.target.checked;
                        document.querySelectorAll('#productionCategoryTableBody input[type="checkbox"]').forEach(cb => {
                            if (cb.id !== 'prod-cat-select-all') cb.checked = checked;
                        });
                        appState.selectedProductionCategories = checked ? [...productionCategories] : [];
                    } else {
                        appState.selectedProductionCategories = Array.from(document.querySelectorAll('#productionCategoryTableBody input[type="checkbox"]:not(#prod-cat-select-all):checked')).map(cb => cb.value);
                        // Sync select-all checkbox
                        const allChecked = appState.selectedProductionCategories.length === productionCategories.length;
                        allCheckbox.checked = allChecked;
                    }
                    updateProductionChart();
                }
            });
        }

        function setupProductionControls() {
            const resetZoomBtn = document.getElementById('resetZoom');
            resetZoomBtn.addEventListener('click', () => {
                if (productionChart) {
                    productionChart.resetZoom();
                }
            });
        }

        function sortTable(column) {
            const direction = (appState.currentSort.column === column && appState.currentSort.direction === 'asc') ? 'desc' : 'asc';
            appState.currentSort = { column, direction };

            // Clear all sort indicators and set the new one
            document.querySelectorAll('.sort-indicator').forEach(indicator => {
                indicator.className = 'sort-indicator';
            });
            const currentHeader = document.querySelector(`th[data-sort="${column}"] .sort-indicator`);
            currentHeader.className = `sort-indicator ${direction}`;

            // Sort the underlying facilities array
            sortFacilities(column, direction);

            // Re-filter and update display with the newly sorted data
            updateCategoriesAndTotals();
            updateTableOrMap();

            // Reset to first page after sorting
            appState.currentPage = 1;
            updateTableOrMap();
        }

        function updateTable() {
            if (!appState.isTableView) {
                throw new Error('updateTable called in map view');
            }
            // Use the same filtered facilities as the map (already sorted in underlying array)
            displayedFacilities = [...filteredFacilities];

            // Reset to first page when data changes
            appState.currentPage = 1;
            renderTable();
        }

        function renderTable() {
            const tbody = document.getElementById('facilitiesTableBody');
            tbody.innerHTML = '';

            // Calculate pagination
            const startIndex = (appState.currentPage - 1) * facilitiesPerPage;
            const endIndex = Math.min(startIndex + facilitiesPerPage, displayedFacilities.length);
            const facilitiesToShow = displayedFacilities.slice(startIndex, endIndex);

            facilitiesToShow.forEach(facility => {
                const row = document.createElement('tr');

                // Energy Source with color indicator
                const sourceCell = document.createElement('td');
                sourceCell.className = 'energy-source-cell';
                const colorIndicator = document.createElement('span');
                colorIndicator.className = 'table-color-indicator';
                const color = CATEGORY_COLORS[facility.SubCategory] || [128, 128, 128];
                colorIndicator.style.backgroundColor = `rgb(${color.join(',')})`;
                sourceCell.appendChild(colorIndicator);
                sourceCell.appendChild(document.createTextNode(facility.SubCategory || ''));

                // Power
                const powerCell = document.createElement('td');
                powerCell.className = 'numeric';
                powerCell.textContent = (facility.TotalPower || 0).toLocaleString(undefined, {
                    minimumFractionDigits: 1,
                    maximumFractionDigits: 1
                });

                // Municipality
                const municipalityCell = document.createElement('td');
                municipalityCell.textContent = facility.Municipality || '';

                // Canton
                const cantonCell = document.createElement('td');
                cantonCell.textContent = facility.Canton || '';

                // Start date
                const startCell = document.createElement('td');
                startCell.textContent = facility.BeginningOfOperation || '';

                // GPS indicator
                const gpsCell = document.createElement('td');
                gpsCell.className = 'gps-indicator';
                if (facility.lat && facility.lon) {
                    gpsCell.innerHTML = '<span class="gps-yes">‚úì</span>';
                } else {
                    gpsCell.innerHTML = '<span class="gps-no">‚úó</span>';
                }

                row.appendChild(sourceCell);
                row.appendChild(powerCell);
                row.appendChild(municipalityCell);
                row.appendChild(cantonCell);
                row.appendChild(startCell);
                row.appendChild(gpsCell);
                tbody.appendChild(row);
            });
            updatePaginationControls();
        }

        function createPageNumberSpan() {
            const span = document.createElement('span');
            span.id = 'currentPageNumber';
            span.style.cursor = 'pointer';
            span.style.textDecoration = 'underline';
            span.style.color = '#2196F3';
            span.textContent = appState.currentPage.toString();
            span.addEventListener('click', handlePageNumberClick);
            return span;
        }

        function createPageNumberInput() {
            const input = document.createElement('input');
            input.type = 'number';
            input.min = '1';
            input.max = totalPages.toString();
            input.value = appState.currentPage.toString();
            input.style.width = '50px';
            input.style.textAlign = 'center';
            input.style.border = '1px solid #2196F3';
            input.style.borderRadius = '3px';
            input.style.padding = '2px';
            input.style.fontSize = '12px';
            return input;
        }

        function handlePageNumberClick(e) {
            const span = e.target;
            const totalPages = Math.ceil(displayedFacilities.length / facilitiesPerPage);

            // Replace span with input
            const input = createPageNumberInput();
            span.parentNode.replaceChild(input, span);
            input.focus();
            input.select();

            const finishEdit = () => {
                const pageNumber = parseInt(input.value);
                if (pageNumber >= 1 && pageNumber <= totalPages) {
                    appState.currentPage = pageNumber;
                }
                // Restore span with current page number
                const newSpan = createPageNumberSpan();
                input.parentNode.replaceChild(newSpan, input);
                if (pageNumber >= 1 && pageNumber <= totalPages) {
                    renderTable();
                }
            };

            input.addEventListener('blur', finishEdit);
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    input.blur();
                } else if (e.key === 'Escape') {
                    // Cancel edit - restore span without changing page
                    const newSpan = createPageNumberSpan();
                    input.parentNode.replaceChild(newSpan, input);
                }
            });
        }

        function updatePaginationControls() {
            const totalPages = Math.ceil(displayedFacilities.length / facilitiesPerPage);
            p = appState.currentPage;

            // Update page info
            document.getElementById('currentPageNumber').textContent = p;
            document.getElementById('totalPages').textContent = totalPages;

            // Update button states
            document.getElementById('firstPage').disabled = appState.currentPage <= 1;
            document.getElementById('prevPage').disabled = appState.currentPage <= 1;
            document.getElementById('nextPage').disabled = appState.currentPage >= totalPages;
            document.getElementById('lastPage').disabled = appState.currentPage >= totalPages;
        }

        function updateCategoriesAndTotals() {
            const categoryStats = {};
            categories.forEach(category => {
                categoryStats[category] = { count: 0, capacity: 0 };
            });

            let totalCapacity = 0;
            let totalCount = 0;
            filteredFacilities = [];

            facilities
                .filter(f => f.TotalPower >= appState.minPower && f.TotalPower <= appState.maxPower)
                .filter(f => facilityMatchesSearch(f))
                .forEach(f => {
                    const category = f.SubCategory;

                    // Update category stats
                    if (categoryStats[category]) {
                        categoryStats[category].count++;
                        categoryStats[category].capacity += f.TotalPower / 1000; // Convert to MW
                    }

                    // Add to filtered facilities if category is selected
                    if (appState.selectedCategories.includes(category)) {
                        filteredFacilities.push(f);
                        totalCapacity += f.TotalPower / 1000; // Convert to MW
                        totalCount++;
                    }
                });
            // Update category display elements
            categories.forEach(category => {
                const stats = categoryStats[category];
                const countElement = document.getElementById(`count-${category.replace(/\s+/g, '-')}`);
                const capacityElement = document.getElementById(`capacity-${category.replace(/\s+/g, '-')}`);
                if (countElement) countElement.textContent = stats.count.toLocaleString();
                if (capacityElement) capacityElement.textContent = stats.capacity.toFixed(1);
            });

            // Update totals
            document.getElementById('totalCount').textContent = totalCount.toLocaleString();
            document.getElementById('totalCapacity').textContent = totalCapacity.toFixed(1);
        }

        function updateTotals() {
            filteredFacilities = facilities
                .filter(f => appState.selectedCategories.includes(f.SubCategory) && f.TotalPower >= appState.minPower && f.TotalPower <= appState.maxPower)
                .filter(f => facilityMatchesSearch(f));
            const totalCount = filteredFacilities.length;
            const totalCapacity = filteredFacilities.reduce((total, f) => total + f.TotalPower, 0) / 1000; // Convert to MW

            document.getElementById('totalCount').textContent = totalCount.toLocaleString();
            document.getElementById('totalCapacity').textContent = totalCapacity.toFixed(1);
        }

        function updateMap() {
            if (appState.isTableView) {
                throw new Error('updateMap called in table view');
            }
            mapFacilities = filteredFacilities.filter(f => f.lat && f.lon)
            const scatterplotLayer = new ScatterplotLayer({
                id: 'facilities',
                data: mapFacilities,
                getPosition: d => [d.lon, d.lat],
                getFillColor: d => CATEGORY_COLORS[d.SubCategory] || [128, 128, 128],
                getRadius: d => 12*Math.pow(Math.log(d.TotalPower  + 1), 2),
                radiusUnits: 'meters',
                opacity: 0.4,
                pickable: true,
                radiusMinPixels: 2,
                radiusMaxPixels: 100,
                updateTriggers: {
                    getFillColor: appState.selectedCategories,
                    getRadius: [appState.minPower, appState.maxPower]
                }
            });

            deckgl.setProps({ layers: [scatterplotLayer] });

            document.getElementById('facilityCount').innerHTML =
                `${filteredFacilities.length.toLocaleString()} facilities match filters.<br/>Map shows ${mapFacilities.length.toLocaleString()} facilities.` +
                `<span class="info-asterisk">*` +
                `<span class="tooltip">${(filteredFacilities.length - mapFacilities.length).toLocaleString()} facilities lack GPS coordinates or geocodable addresses.</span>` +
                `</span>`;
        }

        // Info modal functionality
        const infoButton = document.getElementById('infoButton');
        const infoModal = document.getElementById('infoModal');
        const closeModal = document.getElementById('closeModal');

        infoButton.addEventListener('click', () => {
            infoModal.classList.add('show');
        });

        closeModal.addEventListener('click', () => {
            infoModal.classList.remove('show');
        });

        // Close modal when clicking outside
        infoModal.addEventListener('click', (e) => {
            if (e.target === infoModal) {
                infoModal.classList.remove('show');
            }
        });

        // Close modal with Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && infoModal.classList.contains('show')) {
                infoModal.classList.remove('show');
            }
        });

        function createProductionChart() {
            const ctx = document.getElementById('productionChart').getContext('2d');

            productionChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    datasets: []
                },
                options: {
                    animation: false,
                    normalized: true,
                    parsing: false,
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    onHover: (event, activeElements, chart) => {
                        const canvas = chart.canvas;
                        canvas.style.cursor = activeElements.length > 0 ? 'pointer' : 'grab';
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        title: {
                            display: true,
                            text: 'Swiss energy production over time'
                        },
                        zoom: {
                                                    zoom: {
                            wheel: {
                                enabled: true,
                                speed: 0.1
                            },
                            pinch: {
                                enabled: true
                            },
                            drag: {
                                enabled: false
                            },
                            mode: 'x',
                            onZoomComplete: ({chart}) => {
                                updateTimeUnit(chart);
                                updateProductionStats(chart.options.scales.x.min, chart.options.scales.x.max);
                                appState.productionChart.xmin = chart.options.scales.x.min;
                                appState.productionChart.xmax = chart.options.scales.x.max;
                            }
                        },
                        pan: {
                            enabled: true,
                            mode: 'x',
                            onPanComplete: ({chart}) => {
                                updateProductionStats(chart.scales.x.min, chart.scales.x.max);
                                appState.productionChart.xmin = chart.scales.x.min;
                                appState.productionChart.xmax = chart.scales.x.max;
                            }
                        },
                            limits: {
                                x: {
                                    min: 'original',
                                    max: 'original',
                                    minRange: 7*24*60*60*1000,
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            type: 'time',
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45,
                            },
                            time: {
                                unit: 'quarter',
                                displayFormats: {
                                    day: 'dd MMM yyyy',
                                    week: 'dd MMM yyyy',
                                    month: 'MMM yyyy',
                                    quarter: 'MMM yyyy',
                                    year: 'yyyy'
                                },
                                tooltipFormat: 'MMM yyyy'
                            },
                            title: {
                                display: true,
                                text: 'Date'
                            },
                            stacked: true
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Production (GWh)'
                            },
                            beginAtZero: true,
                            stacked: true
                        }
                    },
                    datasets: {
                        bar: {
                            categoryPercentage: 0.9, // Reduce space between bar groups
                            barPercentage: 1.0, // Bars take full width of their category
                        }
                    },
                }
            });
            window.productionChartKeyListener = (e) => {
                if (!isProductionMode || !productionChart) return;
                switch (e.key) {
                    case '-': case '_':
                        e.preventDefault();
                        productionChart.zoom(0.8);
                        productionChart.options.plugins.zoom.zoom.onZoomComplete({chart: productionChart});
                        break;
                    case '+': case '=':
                        e.preventDefault();
                        productionChart.zoom(1.2);
                        productionChart.options.plugins.zoom.zoom.onZoomComplete({chart: productionChart});
                        break;
                    case 'ArrowLeft':
                        e.preventDefault();
                        productionChart.pan({ x: 100 });
                        productionChart.options.plugins.zoom.pan.onPanComplete({chart: productionChart});
                        break;
                    case 'ArrowRight':
                        e.preventDefault();
                        productionChart.pan({ x: -100 });
                        productionChart.options.plugins.zoom.pan.onPanComplete({chart: productionChart});
                        break;
                }
            };
            document.addEventListener('keydown', window.productionChartKeyListener);
        }

        function aggregateDataByTimeUnit(unit) {
            const aggregated = {};

            productionData.forEach(record => {
                const date = new Date(record.date);
                date.setHours(0,0,0,0);
                switch(unit) {
                    case 'week':
                        date.setDate(date.getDate() - date.getDay());
                        break;
                    case 'month':
                        date.setDate(1);
                        break;
                    case 'quarter':
                        date.setFullYear(date.getFullYear(), Math.floor(date.getMonth() / 3) * 3, 1);
                        break;
                    case 'year':
                        date.setFullYear(date.getFullYear(), 0, 1);
                        break;
                    default:
                        break;
                }
                const key = date.getTime();
                if (!aggregated[key]) {
                    aggregated[key] = {
                        date: key,
                        prod: new Array(6).fill(0),
                        count: 0
                    };
                }
                record.prod.forEach((value, index) => {
                    aggregated[key].prod[index] += value;
                });
                aggregated[key].count += 1;
            });

            // Create time-sorted array of aggregated data
            return Object.values(aggregated).map(item => {
                return {
                    date: item.date,
                    prod: item.prod
                };
            }).sort((a, b) => a.date - b.date);
        }

        function updateTimeUnit(chart) {
            if (!chart || !chart.scales || !chart.scales.x || !chart.scales.x.max || !chart.scales.x.min) {
                console.warn('Chart scales not available for time unit update');
                return;
            }

            const xScale = chart.scales.x;
            // chart.scales.x.{max,min} are Unix timestamps in milliseconds
            const range = xScale.max - xScale.min;
            const days = range / 24 / 60 / 60 / 1000;

            let unit = 'quarter', tooltipFormat = 'MMM yyyy';
            if (days <= 90) {unit = 'day'; tooltipFormat = 'dd MMM yyyy';}
            else if (days <= 365) {unit = 'week'; tooltipFormat = 'dd MMM yyyy';}
            else if (days <= 1095) {unit = 'month'; tooltipFormat = 'MMM yyyy';} // 3 years

            const currentUnit = chart.options.scales.x.time.unit;
            if (currentUnit === unit) return;
            // console.log(`Zoom: ${days.toFixed(0)} days visible, switching ${currentUnit} -> ${unit}`);
            chart.options.scales.x.time.unit = unit;
            chart.options.scales.x.time.tooltipFormat = tooltipFormat;
            updateProductionChart(xScale.min, xScale.max);
        }

        function updateProductionChart(minDate, maxDate) {
            if (!productionChart) {
                createProductionChart();
            }

            let currentUnit = productionChart.options.scales.x.time.unit

            const aggregatedData = aggregateDataByTimeUnit(currentUnit);
            const datasets = [];

            appState.selectedProductionCategories.reverse().forEach((category, index) => {
                const categoryIndex = productionCategories.indexOf(category);
                if (categoryIndex === -1) return;

                const data = aggregatedData.map(record => ({
                    x: record.date,
                    y: record.prod[categoryIndex]
                }));

                datasets.push({
                    label: category,
                    data: data,
                    backgroundColor: `rgba(${PRODUCTION_COLORS[category].join(',')}, 0.8)`,
                    borderColor: `rgb(${PRODUCTION_COLORS[category].join(',')})`,
                    borderWidth: 1,
                    stack: 'production'
                });
            });

            productionChart.data.datasets = datasets;
            productionChart.options.plugins.title.text = `Energy production (GWh ${timeUnitNames[currentUnit]})`;

            // Set zoom and pan limits to data range
            if (minDate && maxDate) {
                productionChart.options.scales.x.min = minDate;
                productionChart.options.scales.x.max = maxDate;
            } else if (appState.productionChart.xmin && appState.productionChart.xmax) {
                // Use saved bounds from state
                productionChart.options.scales.x.min = appState.productionChart.xmin;
                productionChart.options.scales.x.max = appState.productionChart.xmax;
            } else {
                // Default to full data range
                productionChart.options.scales.x.min = aggregatedData[0].date;
                productionChart.options.scales.x.max = aggregatedData[aggregatedData.length - 1].date;
            }
            productionChart.options.plugins.zoom.limits.x.min = aggregatedData[0].date;
            productionChart.options.plugins.zoom.limits.x.max = aggregatedData[aggregatedData.length - 1].date;
            productionChart.update();
        }
    </script>
</body>
</html>
