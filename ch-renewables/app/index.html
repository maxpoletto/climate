<!DOCTYPE html>
<html>
<head>
    <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
    <title>Swiss Energy Facilities Map</title>
    <script src="https://unpkg.com/deck.gl@latest/dist.min.js"></script>
    <script src="https://cdn.maptiler.com/maptiler-sdk-js/v3.0.1/maptiler-sdk.umd.min.js"></script>
    <link href="https://cdn.maptiler.com/maptiler-sdk-js/v3.0.1/maptiler-sdk.css" rel="stylesheet" />
    <style>
        html, body {margin: 0; height: 100%; overflow: hidden}
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; }
        .maplibregl-ctrl-group { display: none; }
        #controls {
            position: absolute;
            top: 10px;
            right: 10px;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 1;
            width: 280px;
            max-height: 80vh;
            overflow-y: auto;
        }
        .control-section {
            margin-bottom: 20px;
        }
        .control-section h3 {
            margin: 0 0 10px 0;
            font-size: 14px;
            font-weight: 600;
            color: #333;
        }
        .category-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }
        .category-table th {
            background: #f5f5f5;
            padding: 8px 4px;
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid #ddd;
            font-size: 11px;
        }
        .category-table th:nth-child(2), .category-table th:nth-child(3) {
            text-align: right;
        }
        .category-table th:nth-child(2), .category-table td:nth-child(2) {
            width: 60px;
            min-width: 60px;
        }
        .category-table th:nth-child(3), .category-table td:nth-child(3) {
            width: 70px;
            min-width: 70px;
        }
        .category-table td {
            padding: 6px 4px;
            border-bottom: 1px solid #eee;
            vertical-align: middle;
        }
        .category-table .source-cell {
            display: flex;
            align-items: center;
            gap: 0;
        }
        .category-table tr:hover {
            background: #f9f9f9;
        }
        .category-table .totals-row {
            font-weight: 600;
            background: #f0f0f0;
            border-top: 2px solid #ccc;
        }
        .category-table .totals-row td {
            border-bottom: none;
        }
        .category-checkbox {
            margin: 0;
            margin-right: 6px;
        }
        .category-label {
            display: flex;
            align-items: center;
            cursor: pointer;
            font-size: 11px;
        }
        .color-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            border: 1px solid #ccc;
            margin-right: 6px;
            flex-shrink: 0;
        }
        .count-cell, .capacity-cell {
            text-align: right;
            font-size: 11px;
        }
        .power-control {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .power-values {
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            color: #666;
        }
        #powerFilter {
            width: 100%;
        }
        .facility-count {
            font-size: 11px;
            color: #666;
            text-align: center;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #eee;
            line-height: 1.3;
        }
        
        /* Mobile responsiveness */
        @media (max-width: 480px) {
            #controls {
                width: 260px;
                font-size: 11px;
            }
            .category-table th:nth-child(2), .category-table td:nth-child(2) {
                width: 50px;
                min-width: 50px;
            }
            .category-table th:nth-child(3), .category-table td:nth-child(3) {
                width: 60px;
                min-width: 60px;
            }
            .category-table th, .category-table td {
                padding: 4px 2px;
            }
            .category-label {
                font-size: 10px;
            }
            .count-cell, .capacity-cell {
                font-size: 10px;
            }
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <div id="controls">
        <div class="control-section">
            <h3>Energy Facilities</h3>
            <table id="categoryTable" class="category-table">
                <thead>
                    <tr>
                        <th>Source</th>
                        <th>Count</th>
                        <th>MW</th>
                    </tr>
                </thead>
                <tbody id="categoryTableBody">
                    <!-- Table rows will be populated dynamically -->
                </tbody>
                <tfoot>
                    <tr class="totals-row">
                        <td>Selected Totals</td>
                        <td id="totalCount" class="count-cell">-</td>
                        <td id="totalCapacity" class="capacity-cell">-</td>
                    </tr>
                </tfoot>
            </table>
        </div>
        <div class="control-section">
            <h3>Minimum Power: <span id="currentPower">0.1 kW</span></h3>
            <div class="power-control">
                <input type="range" id="powerFilter" min="0" max="7" step="0.1" value="0">
                <div class="power-values">
                    <span>0.1 kW</span>
                    <span>1M kW</span>
                </div>
            </div>
        </div>
        <div class="facility-count" id="facilityCount">Loading...</div>
    </div>

    <script>
        const {Deck, ScatterplotLayer} = deck;

        const MAPTILER_KEY = 'HtGwidy8WklIVYnFKMJk';
        let facilities = [];
        let deckgl;

        // Color palette for different subcategories
        const CATEGORY_COLORS = {
            'Photovoltaic': [255, 193, 7],        // Amber/Yellow - solar
            'Hydroelectric power': [33, 150, 243], // Blue - water
            'Wind energy': [76, 175, 80],          // Green - wind
            'Biomass': [139, 69, 19],              // Brown - organic
            'Natural gas': [255, 87, 34],          // Orange-red - gas
            'Waste': [158, 158, 158],              // Gray - waste
            'Nuclear energy': [156, 39, 176],      // Purple - nuclear
            'Crude oil': [96, 125, 139]            // Blue-gray - oil
        };

        function initialize() {
            maptilersdk.config.apiKey = MAPTILER_KEY;
            deckgl = new deck.DeckGL({
                container: 'map',
                map: maptilersdk,
                mapStyle: maptilersdk.MapStyle.BASIC,
                initialViewState: {
                    longitude: 8.2275,
                    latitude: 46.8182,
                    zoom: 8,
                    pitch: 0,
                    bearing: 0
                },
                controller: true,
                layers: [],
                getTooltip: ({object}) => {
                    if (!object) return null;
                    return {
                        html: `
                            <strong>${object.SubCategory}</strong><br/>
                            Power: ${object.TotalPower.toLocaleString()} kW<br/>
                            Location: ${object.Municipality}, ${object.Canton}<br/>
                            Started: ${object.BeginningOfOperation}
                        `,
                        style: {
                            backgroundColor: 'white',
                            fontSize: '12px',
                            padding: '8px',
                            borderRadius: '4px',
                            boxShadow: '0 2px 8px rgba(0,0,0,0.15)'
                        }
                    };
                }
            });
            
            loadData();
        }

        async function loadData() {
            try {
                const response = await fetch('ElectricityProductionPlant.json');
                facilities = await response.json();
                
                setupCategoryCheckboxes();
                setupEventListeners();
                updateMap();
                
                console.log(`Loaded ${facilities.length} facilities`);
            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('facilityCount').textContent = 'Error loading data';
            }
        }

        function setupCategoryCheckboxes() {
            const categories = [...new Set(facilities.map(f => f.SubCategory))].sort();
            const container = document.getElementById('categoryTableBody');
            
            categories.forEach(category => {
                const tr = document.createElement('tr');
                
                // Source column with checkbox and color indicator
                const sourceCell = document.createElement('td');
                sourceCell.className = 'source-cell';
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.className = 'category-checkbox';
                checkbox.id = `cat-${category.replace(/\s+/g, '-')}`;
                checkbox.value = category;
                checkbox.checked = true;
                
                const label = document.createElement('label');
                label.className = 'category-label';
                label.htmlFor = checkbox.id;
                
                const colorIndicator = document.createElement('span');
                colorIndicator.className = 'color-indicator';
                const color = CATEGORY_COLORS[category] || [128, 128, 128];
                colorIndicator.style.backgroundColor = `rgb(${color.join(',')})`;
                
                const text = document.createElement('span');
                text.textContent = category;
                
                label.appendChild(colorIndicator);
                label.appendChild(text);
                sourceCell.appendChild(checkbox);
                sourceCell.appendChild(label);
                
                // Count column
                const countCell = document.createElement('td');
                countCell.className = 'count-cell';
                countCell.id = `count-${category.replace(/\s+/g, '-')}`;
                
                // Capacity column (in MW)
                const capacityCell = document.createElement('td');
                capacityCell.className = 'capacity-cell';
                capacityCell.id = `capacity-${category.replace(/\s+/g, '-')}`;
                
                tr.appendChild(sourceCell);
                tr.appendChild(countCell);
                tr.appendChild(capacityCell);
                container.appendChild(tr);
            });
            
            // Update initial statistics
            updateCategoryStats();
        }

        function updateCategoryStats() {
            const minPower = getCurrentMinPower();
            const categories = [...new Set(facilities.map(f => f.SubCategory))].sort();
            
            categories.forEach(category => {
                const filteredFacilities = facilities.filter(f => 
                    f.SubCategory === category && 
                    f.TotalPower >= minPower &&
                    f.lat && f.lon
                );
                
                const count = filteredFacilities.length;
                const totalCapacity = filteredFacilities.reduce((total, f) => total + f.TotalPower, 0) / 1000; // Convert to MW
                
                const countElement = document.getElementById(`count-${category.replace(/\s+/g, '-')}`);
                const capacityElement = document.getElementById(`capacity-${category.replace(/\s+/g, '-')}`);
                
                if (countElement) countElement.textContent = count.toLocaleString();
                if (capacityElement) capacityElement.textContent = totalCapacity.toFixed(1);
            });
            
            updateTotals();
        }

        function updateTotals() {
            const selectedCategories = getSelectedCategories();
            const minPower = getCurrentMinPower();
            
            const selectedFacilities = facilities.filter(f => 
                selectedCategories.includes(f.SubCategory) &&
                f.TotalPower >= minPower &&
                f.lat && f.lon
            );
            
            const totalCount = selectedFacilities.length;
            const totalCapacity = selectedFacilities.reduce((total, f) => total + f.TotalPower, 0) / 1000; // Convert to MW
            
            document.getElementById('totalCount').textContent = totalCount.toLocaleString();
            document.getElementById('totalCapacity').textContent = totalCapacity.toFixed(1);
        }

        function setupEventListeners() {
            // Category checkboxes - use event delegation on the table
            document.getElementById('categoryTableBody').addEventListener('change', function(e) {
                if (e.target.type === 'checkbox') {
                    updateTotals();
                    updateMap();
                }
            });
            
            // Power slider
            const powerSlider = document.getElementById('powerFilter');
            powerSlider.addEventListener('input', function() {
                const logValue = Math.pow(10, parseFloat(this.value) - 1);
                const displayValue = logValue < 1000 
                    ? `${logValue.toFixed(1)} kW`
                    : `${(logValue / 1000).toFixed(1)}M kW`;
                document.getElementById('currentPower').textContent = displayValue;
                updateCategoryStats(); // This will also call updateTotals() and updateMap()
                updateMap();
            });
            
            // Initial power display
            powerSlider.dispatchEvent(new Event('input'));
        }

        function getSelectedCategories() {
            const checkboxes = document.querySelectorAll('#categoryTableBody input[type="checkbox"]:checked');
            return Array.from(checkboxes).map(cb => cb.value);
        }

        function getCurrentMinPower() {
            const sliderValue = parseFloat(document.getElementById('powerFilter').value);
            return Math.pow(10, sliderValue - 1); // -1 to start from 0.1 instead of 1
        }

        function updateMap() {
            const selectedCategories = getSelectedCategories();
            const minPower = getCurrentMinPower();

            const filtered = facilities.filter(f => 
                selectedCategories.includes(f.SubCategory) &&
                f.TotalPower >= minPower &&
                f.lat && f.lon // Ensure coordinates exist
            );

            const scatterplotLayer = new ScatterplotLayer({
                id: 'facilities',
                data: filtered,
                getPosition: d => [d.lon, d.lat],
                getFillColor: d => CATEGORY_COLORS[d.SubCategory] || [128, 128, 128],
                getRadius: d => Math.max(50, Math.log(d.TotalPower + 1) * 30),
                opacity: 0.7,
                pickable: true,
                radiusMinPixels: 3,
                radiusMaxPixels: 100,
                updateTriggers: {
                    getFillColor: selectedCategories,
                    getRadius: minPower
                }
            });

            deckgl.setProps({ layers: [scatterplotLayer] });
            
            // Update facility count
            document.getElementById('facilityCount').textContent = 
                `Showing ${filtered.length.toLocaleString()} of ${facilities.length.toLocaleString()} facilities`;
        }

        // Initialize the application
        initialize();
    </script>
</body>
</html>
